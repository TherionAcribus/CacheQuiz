<div class="form-wrapper">
    <div class="form-header">
        <h2>{% if image %}Éditer l'image{% else %}Nouvelle image{% endif %}</h2>
        <button class="btn-close" type="button" onclick="{% if embedded %}closeEmbeddedImageModal(){% else %}document.getElementById('image-form-container').classList.add('hidden'){% endif %}">✕</button>
    </div>

    <form action="{% if image %}/api/image/{{ image.id }}{% else %}/api/image{% endif %}"
          method="post"
          {% if not embedded %}hx-post="{% if image %}/api/image/{{ image.id }}{% else %}/api/image{% endif %}" hx-target="#images-list" hx-swap="innerHTML" hx-on::after-request="document.getElementById('image-form-container').classList.add('hidden')"{% endif %}
          enctype="multipart/form-data">

        <div class="form-grid">
            <div class="form-column">
                <div class="form-group">
                    {% if embedded %}
                    <input type="hidden" name="embedded" value="1">
                    <input type="hidden" name="select_id" value="{{ select_id }}">
                    {% endif %}
                    <label for="title">Titre *</label>
                    <input type="text" id="title" name="title" value="{{ image.title if image else '' }}" required>
                </div>
                <div class="form-group">
                    <label for="alt_text">Texte alternatif</label>
                    <input type="text" id="alt_text" name="alt_text" value="{{ image.alt_text if image else '' }}" placeholder="Description de l'image">
                </div>
                <div class="form-group">
                    <label for="copyright_credits">Crédits</label>
                    <input type="text" id="copyright_credits" name="copyright_credits" value="{{ image.copyright_credits if image else '' }}" placeholder="Auteur, source, etc.">
                </div>
                <div class="form-group">
                    <label for="copyright_link">Lien copyright</label>
                    <input type="url" id="copyright_link" name="copyright_link" value="{{ image.copyright_link if image else '' }}" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label for="file">Fichier {% if not image %}*{% endif %}</label>
                    <input type="file" id="file" name="file" {% if not image %}required{% endif %} accept="image/*">
                </div>
            </div>
            <div class="form-column">
                {% if image %}
                <div class="form-group">
                    <label>Aperçu</label>
                    <div class="image-preview">
                        <img src="/uploads/{{ image.filename }}" alt="{{ image.alt_text or image.title }}">
                    </div>
                </div>
                <div class="form-info">
                    <p><strong>Nom de fichier:</strong> {{ image.filename }}</p>
                    <p><strong>Taille:</strong> {{ image.size_bytes or 0 }} o</p>
                    <p><strong>Type:</strong> {{ image.mime_type }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="form-actions">
            {% if embedded %}
            <button type="button" class="btn btn-secondary" onclick="closeEmbeddedImageModal()">Annuler</button>
            {% else %}
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('image-form-container').classList.add('hidden')">Annuler</button>
            {% endif %}
            <button type="{% if embedded %}button" onclick="submitEmbeddedImageForm(this.form){% else %}submit{% endif %}" class="btn btn-primary">{% if image %}Mettre à jour{% else %}Créer{% endif %}</button>
        </div>
    </form>
</div>

<style>
    .image-preview{display:flex;align-items:center;justify-content:center;background:var(--bg-color);border-radius:.5rem;overflow:hidden;aspect-ratio:4/3;border:1px dashed var(--border-color)}
    .image-preview img{max-width:100%;max-height:100%;object-fit:contain}
</style>

{% if embedded %}
<!-- Mode embarqué: le traitement est géré via JavaScript -->
<script>
// Vérifier que les fonctions nécessaires sont disponibles
console.log('[image_form embedded] submitEmbeddedImageForm available:', typeof window.submitEmbeddedImageForm);
console.log('[image_form embedded] onEmbeddedImageCreated available:', typeof window.onEmbeddedImageCreated);

// Fonction appelée après création réussie d'une image en mode embarqué
function handleEmbeddedImageSuccess(data) {
    console.log('[handleEmbeddedImageSuccess] called with:', data);
    if (window.onEmbeddedImageCreated && data && data.created_image) {
        window.onEmbeddedImageCreated(data.created_image, data.select_id || '');
    }
    // Fermer la modale
    closeEmbeddedImageModal();
}

// Fonction pour fermer la modale embarquée
function closeEmbeddedImageModal() {
    console.log('[closeEmbeddedImageModal] closing modal');
    var modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.style.display = 'none';
        // Supprimer la modale du DOM
        modal.remove();
    }
}

// Fonction de fallback si submitEmbeddedImageForm n'est pas disponible
function fallbackSubmitEmbeddedImageForm(formEl) {
    console.log('[fallbackSubmitEmbeddedImageForm] called');
    var url = formEl.getAttribute('action');
    var formData = new FormData(formEl);
    formData.set('embedded','1');
    var selectId = formEl.querySelector('input[name="select_id"]').value || '';
    console.log('[fallback] submitting to:', url, 'with selectId:', selectId);

    fetch(url, { method: 'POST', body: formData, headers: { 'HX-Request': 'true' }})
      .then(function(r){
          console.log('[fallback] response status:', r.status);
          if (!r.ok) throw new Error('Erreur HTTP ' + r.status);
          return r.json();
      })
      .then(function(json){
          console.log('[fallback] received JSON:', json);
          if (json && json.created_image){
              handleEmbeddedImageSuccess(json);
          }
      })
      .catch(function(err){
          console.error('[fallback] error:', err);
          alert('Erreur lors de la création de l\'image: ' + err.message);
      });
    return false;
}

// Remplacer submitEmbeddedImageForm par fallback si nécessaire
if (typeof window.submitEmbeddedImageForm === 'undefined') {
    console.log('[image_form] submitEmbeddedImageForm not found, using fallback');
    window.submitEmbeddedImageForm = fallbackSubmitEmbeddedImageForm;
} else {
    console.log('[image_form] submitEmbeddedImageForm found');
}
</script>
{% endif %}


