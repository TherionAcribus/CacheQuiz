{% if current_user %}
<div id="auth-widget" class="auth-widget">
  <span>Connecté: <strong>{{ current_user.username }}</strong></span>
  {% if current_user.has_any_admin_perm() %}
  <a href="/admin" class="btn btn-outline admin-btn">⚙️ Administration</a>
  {% endif %}
  {% if current_user.password_hash %}
  <a class="btn btn-link" href="/messages">Messages{% if unread_count and unread_count > 0 %} (<span id="unread-count">{{ unread_count }}</span>){% endif %}</a>
  <a class="btn btn-link" href="/preferences">Préférences</a>
  <a class="btn btn-link" href="/me">Mes stats</a>
  {% endif %}
  <form hx-post="/auth/logout" hx-target="#auth-widget" hx-swap="outerHTML" style="display:inline" hx-headers='{"HX-Redirect":"/"}'>
    <button class="btn btn-secondary" type="submit">Se déconnecter</button>
  </form>
</div>
{% else %}
<div id="auth-widget" class="auth-widget">
  {% if show_password_form %}
  <!-- Afficher le message d'erreur si présent -->
  {% if error_message %}
  <div class="alert alert-danger">{{ error_message }}</div>
  {% endif %}
  <!-- Formulaire de connexion avec mot de passe -->
  <form class="password-login" hx-post="/auth/widget-login" hx-target="#auth-widget" hx-swap="outerHTML" hx-headers='{"HX-Redirect":"/play"}'>
    <div class="login-fields">
      <input type="text" name="username" value="{{ login_username }}" placeholder="Votre pseudo" class="pseudo-input" readonly>
      <input type="password" name="password" placeholder="Mot de passe" class="password-input" required>
    </div>
    <button class="btn btn-primary" type="submit">Se connecter</button>
    <button class="btn btn-secondary" type="button" hx-get="/auth/widget" hx-target="#auth-widget" hx-swap="outerHTML">Annuler</button>
  </form>
  {% else %}
  <!-- Formulaire de connexion rapide -->
  <form class="quick-login" hx-post="/auth/quick-login" hx-target="#auth-widget" hx-swap="outerHTML" hx-headers='{"HX-Redirect":"/play"}'>
    <input type="text" name="pseudo" placeholder="Votre pseudo" class="pseudo-input" required>
    <button class="btn btn-primary" type="submit">Entrer</button>
  </form>
  <a href="/login" class="btn btn-secondary">Se connecter</a>
  <a href="/register" class="btn btn-primary">Créer un compte</a>
  {% endif %}
</div>
{% endif %}

<style>
.auth-widget{display:flex;gap:.5rem;align-items:center}
.auth-widget .quick-login{display:flex;gap:.5rem;align-items:center}
.auth-widget .pseudo-input{padding:.75rem 1rem;font-size:1.1rem;border:2px solid rgba(255,255,255,0.3);border-radius:.5rem;background-color:rgba(255,255,255,0.1);color:white;width:200px;min-width:180px}
.auth-widget .pseudo-input::placeholder{color:rgba(255,255,255,0.7)}
.auth-widget .pseudo-input:focus{outline:none;border-color:white;background-color:rgba(255,255,255,0.2)}
.auth-widget .pseudo-input[readonly]{background-color:rgba(255,255,255,0.15);cursor:not-allowed}
.auth-widget .password-input{padding:.75rem 1rem;font-size:1.1rem;border:2px solid rgba(255,255,255,0.3);border-radius:.5rem;background-color:rgba(255,255,255,0.1);color:white;width:200px;min-width:180px}
.auth-widget .password-input::placeholder{color:rgba(255,255,255,0.7)}
.auth-widget .password-input:focus{outline:none;border-color:white;background-color:rgba(255,255,255,0.2)}
.auth-widget .login-fields{display:flex;gap:.5rem;align-items:center}
.auth-widget .password-login{display:flex;gap:.5rem;align-items:center}
.btn-link{background:transparent;border:none;color:var(--primary-color);text-decoration:underline;padding:0}
.btn-link:hover{text-decoration:none}
.admin-btn{background:transparent;border:1px solid rgba(255,255,255,0.3);color:white;padding:0.25rem 0.5rem;border-radius:0.25rem;font-size:0.85rem;text-decoration:none}
.admin-btn:hover{background:rgba(255,255,255,0.1);border-color:white}
.alert{margin-bottom:0.5rem;padding:0.5rem 0.75rem;border-radius:0.25rem;font-size:0.9rem}
.alert-danger{background-color:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
</style>

<script>
// Gérer automatiquement le focus (mot de passe si présent, sinon pseudo)
function focusAuthField() {
    const passwordInput = document.querySelector('.password-input');
    if (passwordInput) {
        passwordInput.focus();
        return;
    }
    const pseudoInput = document.querySelector('.quick-login input[name="pseudo"]');
    if (pseudoInput) {
        pseudoInput.focus();
    }
}

// Focus au chargement initial
document.addEventListener('DOMContentLoaded', focusAuthField);

// Focus après les mises à jour HTMX
document.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.target.id === 'auth-widget') {
        focusAuthField();
    }
});

// Rafraîchissement périodique du compteur de messages non lus
setInterval(function(){
  var el = document.getElementById('unread-count');
  if (!el) return;
  fetch('/api/messages/unread-count').then(function(r){return r.json()}).then(function(data){
    if (data && typeof data.unread_count === 'number') {
      el.textContent = data.unread_count;
    }
  }).catch(function(){});
}, 30000);
</script>


