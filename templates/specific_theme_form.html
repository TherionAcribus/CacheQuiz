<div class="form-wrapper">
    <div class="form-header">
        <h2>{% if specific_theme %}√âditer le sous-th√®me{% else %}Nouveau sous-th√®me{% endif %}</h2>
        <button class="btn-close"
                type="button"
                onclick="{% if embedded %}closeEmbeddedSpecificThemeModal(){% else %}document.getElementById('specific-theme-form-container').classList.add('hidden'){% endif %}">‚úï</button>
    </div>

    <form {% if not embedded %}{% if specific_theme %}
          hx-post="/api/specific-theme/{{ specific_theme.id }}"
          {% else %}
          hx-post="/api/specific-theme"
          {% endif %}
          hx-target="#themes-unified-list"
          hx-swap="innerHTML"
          hx-on::after-request="document.getElementById('specific-theme-form-container').classList.add('hidden')"{% endif %}>

        {% if embedded %}
        <input type="hidden" name="embedded" value="1">
        <input type="hidden" name="select_id" value="{{ select_id }}">
        {% endif %}

        <div class="form-grid">
            <!-- Colonne gauche -->
            <div class="form-column">
                <div class="form-group">
                    <label for="broad_theme_id">Th√®me large parent *</label>
                    <select id="broad_theme_id" name="broad_theme_id" required>
                        {% for theme in broad_themes %}
                        <option value="{{ theme.id }}"
                                {% if (specific_theme and specific_theme.broad_theme_id == theme.id) or (preselected_broad_theme_id and preselected_broad_theme_id == theme.id|string) %}selected{% endif %}>
                            {% if theme.icon %}{{ theme.icon }} {% endif %}{{ theme.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="name">Nom du sous-th√®me *</label>
                    <input type="text"
                           id="name"
                           name="name"
                           value="{{ specific_theme.name if specific_theme else '' }}"
                           placeholder="Ex: Tailles de caches, Reviewers, GPS"
                           required>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description"
                              name="description"
                              rows="3"
                              placeholder="Description du sous-th√®me (optionnel)">{{ specific_theme.description if specific_theme else '' }}</textarea>
                </div>

                <div class="form-group">
                    <label for="language">Langue *</label>
                    <select id="language" name="language" required>
                        <option value="fr" {% if specific_theme and specific_theme.language == 'fr' %}selected{% elif not specific_theme %}selected{% endif %}>üá´üá∑ Fran√ßais (fr)</option>
                        <option value="en" {% if specific_theme and specific_theme.language == 'en' %}selected{% endif %}>üá¨üáß English (en)</option>
                        <option value="de" {% if specific_theme and specific_theme.language == 'de' %}selected{% endif %}>üá©üá™ Deutsch (de)</option>
                        <option value="es" {% if specific_theme and specific_theme.language == 'es' %}selected{% endif %}>üá™üá∏ Espa√±ol (es)</option>
                        <option value="it" {% if specific_theme and specific_theme.language == 'it' %}selected{% endif %}>üáÆüáπ Italiano (it)</option>
                        <option value="nl" {% if specific_theme and specific_theme.language == 'nl' %}selected{% endif %}>üá≥üá± Nederlands (nl)</option>
                        <option value="pt" {% if specific_theme and specific_theme.language == 'pt' %}selected{% endif %}>üáµüáπ Portugu√™s (pt)</option>
                    </select>
                </div>
            </div>

            <!-- Colonne droite -->
            <div class="form-column">
                <div class="form-group">
                    <label for="icon">Ic√¥ne (emoji)</label>
                    <input type="text"
                           id="icon"
                           name="icon"
                           value="{{ specific_theme.icon if specific_theme else '' }}"
                           placeholder="Ex: üìè, üëÄ, üõ∞Ô∏è, üéØ"
                           maxlength="10">
                    <small>Utilisez un emoji pour repr√©senter visuellement ce sous-th√®me</small>
                </div>

                <div class="form-group">
                    <label for="color">Couleur *</label>
                    <input type="color"
                           id="color"
                           name="color"
                           value="{% if specific_theme %}{{ specific_theme.color or specific_theme.broad_theme.color or '#6b7280' }}{% elif preselected_theme %}{{ preselected_theme.color or '#6b7280' }}{% else %}#6b7280{% endif %}">
                    <small>
                        {% if specific_theme and specific_theme.broad_theme %}
                            Couleur du sous-th√®me (h√©rite par d√©faut de "{{ specific_theme.broad_theme.name }}" si non d√©finie)
                        {% elif preselected_theme %}
                            Couleur du sous-th√®me (h√©rite par d√©faut de "{{ preselected_theme.name }}" si non d√©finie)
                        {% else %}
                            Couleur du sous-th√®me
                        {% endif %}
                    </small>
                </div>

                <div class="form-group">
                    <label for="translation_id">ID de traduction (sous-th√®me li√©)</label>
                    <input type="number"
                           id="translation_id"
                           name="translation_id"
                           placeholder="ID du sous-th√®me dans une autre langue"
                           value="{{ specific_theme.translation_id if specific_theme and specific_theme.translation_id else '' }}">
                    <small>Utilis√© pour lier des sous-th√®mes dans diff√©rentes langues</small>
                </div>

                {% if specific_theme %}
                <div class="form-info">
                    <p><strong>Statistiques:</strong></p>
                    <p>Questions utilisant ce sous-th√®me: {{ specific_theme.questions.count() }}</p>
                    <p>Th√®me parent: {% if specific_theme.broad_theme %}{{ specific_theme.broad_theme.name }}{% else %}Aucun{% endif %}</p>
                    <p>ID: {{ specific_theme.id }}</p>
                    <p>Cr√©√©: {{ specific_theme.created_at.strftime('%d/%m/%Y %H:%M') if specific_theme.created_at }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="form-actions">
            <button type="button"
                    class="btn btn-secondary"
                    onclick="{% if embedded %}closeEmbeddedSpecificThemeModal(){% else %}document.getElementById('specific-theme-form-container').classList.add('hidden'){% endif %}">
                Annuler
            </button>
            <button type="{% if embedded %}button" onclick="submitEmbeddedSpecificThemeForm(this.form){% else %}submit{% endif %}" class="btn btn-primary">
                {% if specific_theme %}Mettre √† jour{% else %}Cr√©er{% endif %}
            </button>
        </div>
    </form>
</div>


<style>
    input[type="color"] {
        width: 100%;
        height: 50px;
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        cursor: pointer;
    }

    input[type="color"]:focus {
        outline: none;
        border-color: var(--primary-color);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const broadThemeSelect = document.getElementById('broad_theme_id');
    const colorInput = document.getElementById('color');

    if (broadThemeSelect && colorInput) {
        // Cr√©er un objet avec les couleurs des th√®mes
        const themeColors = {};
        {% for theme in broad_themes %}
        themeColors['{{ theme.id }}'] = {
            name: '{{ theme.name }}',
            color: '{{ theme.color or "" }}'
        };
        {% endfor %}

        function updateDefaultColor() {
            const selectedThemeId = broadThemeSelect.value;
            const selectedTheme = themeColors[selectedThemeId];

            // Ne changer la couleur que si elle n'a pas encore √©t√© modifi√©e par l'utilisateur
            // et qu'aucune couleur sp√©cifique n'√©tait d√©finie (nouveau sous-th√®me)
            if (selectedTheme && selectedTheme.color && !colorInput.dataset.userModified) {
                colorInput.value = selectedTheme.color;
            }
        }

        // Marquer comme modifi√© par l'utilisateur d√®s qu'il change la couleur
        colorInput.addEventListener('input', function() {
            colorInput.dataset.userModified = 'true';
        });

        // Mettre √† jour au changement de s√©lection de th√®me
        broadThemeSelect.addEventListener('change', updateDefaultColor);
    }
});
</script>
