<div class="form-wrapper">
    <div class="form-header">
        <h2>{% if rule %}Éditer le set de règles{% else %}Nouveau set de règles{% endif %}</h2>
        <button class="btn-close" type="button" onclick="document.getElementById('rule-form-container').classList.add('hidden')">✕</button>
    </div>

    <form {% if rule %}hx-post="/api/quiz-rule/{{ rule.id }}"{% else %}hx-post="/api/quiz-rule"{% endif %}
          hx-target="#quiz-rules-list" hx-swap="innerHTML"
          hx-on::after-request="document.getElementById('rule-form-container').classList.add('hidden')">

        <div class="form-grid">
            <div class="form-column">
                <div class="form-group">
                    <label for="name">Nom *</label>
                    <input id="name" name="name" type="text" required value="{{ rule.name if rule else '' }}">
                </div>

                <div class="form-group">
                    <label for="slug">Slug</label>
                    <input id="slug" name="slug" type="text" placeholder="mode-expert" value="{{ rule.slug if rule and rule.slug else '' }}">
                </div>

                <div class="form-group">
                    <label for="created_by_user_id">Créateur *</label>
                    <select id="created_by_user_id" name="created_by_user_id" required>
                        {% for user in users %}
                        <option value="{{ user.id }}" {% if rule and rule.created_by_user_id == user.id %}selected{% endif %}>{{ user.display_name }} (@{{ user.username }})</option>
                        {% endfor %}
                    </select>
                    <small><a href="/users" target="_blank" style="color: var(--primary-color)">→ Gérer les utilisateurs</a></small>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3">{{ rule.description if rule else '' }}</textarea>
                </div>

                <div class="form-group">
                    <label for="comment">Commentaire interne</label>
                    <textarea id="comment" name="comment" rows="2">{{ rule.comment if rule else '' }}</textarea>
                </div>

                <div class="form-group">
                    <label class="checkbox-label"><input type="checkbox" name="is_active" {% if rule and rule.is_active %}checked{% endif %}> Actif</label>
                </div>
            </div>

            <div class="form-column">
                <fieldset class="fieldset">
                    <legend>Timer</legend>
                    <div class="form-group">
                        <label for="timer_seconds">Durée par question (secondes)</label>
                        <input id="timer_seconds" name="timer_seconds" type="number" min="5" step="1" value="{{ rule.timer_seconds if rule else 30 }}">
                    </div>
                </fieldset>

                <fieldset class="fieldset">
                    <legend>Difficultés utilisées</legend>
                    <div class="checkboxes-inline">
                        {% set selected = rule.get_allowed_difficulties() if rule else [] %}
                        {% for d in [1,2,3,4,5] %}
                        <label><input type="checkbox" name="allowed_difficulties" value="{{ d }}" {% if d in selected %}checked{% endif %}> {{ d }}</label>
                        {% endfor %}
                    </div>
                    <div class="form-group">
                        <label>Nombre de questions par difficulté</label>
                        <div class="grid-5">
                            {% for d in [1,2,3,4,5] %}
                            <div>
                                <label for="qpd{{ d }}" class="small">Diff {{ d }}</label>
                                {% set qmap = rule.get_questions_per_difficulty() if rule else {} %}
                                <input id="qpd{{ d }}" name="questions_per_difficulty_{{ d }}" type="number" min="0" step="1" value="{{ qmap.get(d|string) if qmap.get(d|string) else '' }}">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </fieldset>

                <fieldset class="fieldset">
                    <legend>Thèmes utilisés</legend>
                    <label class="checkbox-label"><input type="checkbox" name="use_all_broad_themes" {% if not rule or rule.use_all_broad_themes %}checked{% endif %}> Utiliser tous les thèmes larges</label>
                    <div class="themes-grid-select">
                        {% for theme in themes %}
                        <label class="chip"><input type="checkbox" name="allowed_broad_theme_ids" value="{{ theme.id }}" {% if rule and (not rule.use_all_broad_themes) and (theme in rule.allowed_broad_themes) %}checked{% endif %}> {% if theme.icon %}{{ theme.icon }} {% endif %}{{ theme.name }}</label>
                        {% endfor %}
                    </div>

                    <label class="checkbox-label"><input type="checkbox" name="use_all_specific_themes" {% if not rule or rule.use_all_specific_themes %}checked{% endif %}> Utiliser tous les sous-thèmes</label>
                    <div class="themes-grid-select">
                        {% for st in specific_themes %}
                        <label class="chip"><input type="checkbox" name="allowed_specific_theme_ids" value="{{ st.id }}" {% if rule and (not rule.use_all_specific_themes) and (st in rule.allowed_specific_themes) %}checked{% endif %}> {% if st.icon %}{{ st.icon }} {% endif %}{{ st.name }} ({{ st.broad_theme.name }})</label>
                        {% endfor %}
                    </div>
                </fieldset>

                <fieldset class="fieldset">
                    <legend>Scoring</legend>
                    <div class="form-group">
                        <label for="scoring_base_points">Points par question</label>
                        <input id="scoring_base_points" name="scoring_base_points" type="number" min="0" step="1" value="{{ rule.scoring_base_points if rule else 1 }}">
                    </div>
                    <div class="form-group">
                        <label for="scoring_difficulty_bonus_type">Bonus difficulté</label>
                        <select id="scoring_difficulty_bonus_type" name="scoring_difficulty_bonus_type">
                            {% set s = rule.scoring_difficulty_bonus_type if rule else 'none' %}
                            <option value="none" {% if s == 'none' %}selected{% endif %}>Aucun</option>
                            <option value="add" {% if s == 'add' %}selected{% endif %}>Addition (+N)</option>
                            <option value="mult" {% if s == 'mult' %}selected{% endif %}>Multiplicatif (×N)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valeurs bonus par difficulté</label>
                        <div class="grid-5">
                            {% set bmap = rule.get_difficulty_bonus_map() if rule else {} %}
                            {% for d in [1,2,3,4,5] %}
                            <div>
                                <label for="bonus{{ d }}" class="small">Diff {{ d }}</label>
                                <input id="bonus{{ d }}" name="difficulty_bonus_{{ d }}" type="number" step="0.1" value="{{ bmap.get(d|string) if bmap.get(d|string) else '' }}">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label"><input type="checkbox" name="combo_bonus_enabled" {% if rule and rule.combo_bonus_enabled %}checked{% endif %}> Activer bonus de combo</label>
                        <div class="grid-2">
                            <div>
                                <label for="combo_step" class="small">Taille du palier</label>
                                <input id="combo_step" name="combo_step" type="number" min="2" step="1" value="{{ rule.combo_step if rule and rule.combo_step else '' }}">
                            </div>
                            <div>
                                <label for="combo_bonus_points" class="small">Points par palier</label>
                                <input id="combo_bonus_points" name="combo_bonus_points" type="number" min="0" step="1" value="{{ rule.combo_bonus_points if rule and rule.combo_bonus_points else '' }}">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="perfect_quiz_bonus">Bonus perfect</label>
                        <input id="perfect_quiz_bonus" name="perfect_quiz_bonus" type="number" min="0" step="1" value="{{ rule.perfect_quiz_bonus if rule else 0 }}">
                    </div>
                </fieldset>

                <fieldset class="fieldset">
                    <legend>Messages</legend>
                    <div class="form-group">
                        <label for="intro_message">Message d'introduction</label>
                        <textarea id="intro_message" name="intro_message" rows="2">{{ rule.intro_message if rule else '' }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="success_message">Message de réussite</label>
                        <textarea id="success_message" name="success_message" rows="2">{{ rule.success_message if rule else '' }}</textarea>
                    </div>
                </fieldset>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('rule-form-container').classList.add('hidden')">Annuler</button>
            <button type="submit" class="btn btn-primary">{% if rule %}Mettre à jour{% else %}Créer{% endif %}</button>
        </div>
    </form>
</div>

<style>
.form-wrapper{background:var(--card-bg);border:1px solid var(--border-color);border-radius:.75rem;box-shadow:var(--shadow);padding:1rem;max-width:1100px;width:100%}
.form-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.form-column{display:flex;flex-direction:column;gap:.75rem}
.fieldset{border:1px solid var(--border-color);border-radius:.5rem;padding:.75rem}
.checkboxes-inline{display:flex;gap:1rem;flex-wrap:wrap}
.grid-5{display:grid;grid-template-columns:repeat(5,minmax(90px,1fr));gap:.5rem}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem}
.themes-grid-select{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.5rem;max-height:200px;overflow:auto;border:1px dashed var(--border-color);border-radius:.5rem;padding:.5rem}
.chip{display:flex;align-items:center;gap:.35rem;padding:.35rem .5rem;border:1px solid var(--border-color);border-radius:999px;background:#fff;cursor:pointer}
.small{font-size:.8rem;color:var(--text-light)}
</style>


