<div class="form-wrapper">
    <div class="form-header">
        <h2>{% if rule %}√âditer le set de r√®gles{% else %}Nouveau set de r√®gles{% endif %}</h2>
        <button class="btn-close" type="button" onclick="document.getElementById('rule-form-container').classList.add('hidden')">‚úï</button>
    </div>

    <form {% if rule %}hx-post="/api/quiz-rule/{{ rule.id }}"{% else %}hx-post="/api/quiz-rule"{% endif %}
          hx-target="#quiz-rules-list" hx-swap="innerHTML"
          hx-on::after-request="document.getElementById('rule-form-container').classList.add('hidden')">

        <div class="tabs" hx-on:click="var btn=event.target.closest('.tab, .tab-next'); if(!btn) return; var wrap=event.currentTarget; var nav=wrap.querySelector('.tabs-nav'); var key=btn.classList.contains('tab')?btn.getAttribute('data-tab'):btn.getAttribute('data-next-tab'); if(key){nav.querySelectorAll('.tab').forEach(function(b){var on=b.getAttribute('data-tab')===key; b.classList.toggle('active',on); b.setAttribute('aria-selected',on?'true':'false')}); wrap.querySelectorAll('.tabs-panels .tab-panel').forEach(function(p){p.classList.toggle('active', p.getAttribute('data-tab')===key)});}">
            <div class="tabs-nav" role="tablist" aria-label="R√®gles - onglets">
                <button type="button" class="tab active" data-tab="general" aria-selected="true">G√©n√©ral</button>
                <button type="button" class="tab" data-tab="themes" aria-selected="false">Th√®mes</button>
                <button type="button" class="tab" data-tab="questions" aria-selected="false">S√©lection de questions</button>
                <button type="button" class="tab" data-tab="timing" aria-selected="false">Timer & Difficult√©s</button>
                <button type="button" class="tab" data-tab="scoring" aria-selected="false">Scoring</button>
                <button type="button" class="tab" data-tab="messages" aria-selected="false">Messages</button>
            </div>
            <div class="tabs-panels">
                <div class="tab-panel active" data-tab="general">
            <div class="form-column">
                <div class="form-group">
                    <label for="name">Nom *</label>
                            <input id="name" name="name" type="text" required value="{{ rule.name if rule else '' }}"
                                   onblur="checkRuleName(this)">
                            <div id="name-error" class="field-error"></div>
                </div>

                <div class="form-group">
                    <label for="slug">Slug</label>
                            <input id="slug" name="slug" type="text" placeholder="mode-expert" value="{{ rule.slug if rule and rule.slug else '' }}"
                                   onblur="checkRuleSlug(this)"
                                   oninput="handleSlugInput(this)">
                            <div id="slug-error" class="field-error"></div>
                </div>


                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3">{{ rule.description if rule else '' }}</textarea>
                </div>

                <div class="form-group">
                    <label for="comment">Commentaire interne</label>
                    <textarea id="comment" name="comment" rows="2">{{ rule.comment if rule else '' }}</textarea>
                </div>

                <div class="form-group">
                            <label class="checkbox-label"><input type="checkbox" name="is_active" {% if rule %}{% if rule.is_active %}checked{% endif %}{% else %}{% if defaults.get('is_active', true) %}checked{% endif %}{% endif %}> Actif</label>
                        </div>
                    </div>

                    <div class="tab-actions">
                        <button type="button" class="btn btn-primary tab-next" data-next-tab="themes">Suivant ‚Üí</button>
                    </div>
                </div>

                <div class="tab-panel" data-tab="themes">
                    <div class="form-column">
                        <fieldset class="fieldset">
                            <legend>Pays utilis√©s</legend>
                            <label class="checkbox-label"><input type="checkbox" id="use_all_countries" name="use_all_countries" {% if rule %}{% if rule.use_all_countries %}checked{% endif %}{% else %}{% if defaults.get('use_all_countries', true) %}checked{% endif %}{% endif %} onchange="toggleCountryCheckboxes(this)"> Inclure les questions de tous les pays</label>
                            <div class="countries-grid">
                                {% for country in countries %}
                                <label class="country-checkbox">
                                    <input type="checkbox"
                                           name="allowed_country_ids"
                                           value="{{ country.id }}"
                                           {% if rule %}{% if (not rule.use_all_countries) and (country in rule.allowed_countries) %}checked{% endif %}{% else %}{% if defaults.get('check_all_countries', true) %}checked{% endif %}{% endif %}
                                           onchange="updateUseAllCountries()">
                                    {% if country.flag %}{{ country.flag }} {% endif %}{{ country.name }}
                                    {% if country.code %}({{ country.code }}){% endif %}
                                </label>
                                {% endfor %}
                            </div>
                        </fieldset>

                        <fieldset class="fieldset">
                            <legend>Th√®mes utilis√©s</legend>
                            <label class="checkbox-label"><input type="checkbox" id="use_all_broad_themes" name="use_all_broad_themes" {% if rule %}{% if rule.use_all_broad_themes %}checked{% endif %}{% else %}{% if defaults.get('use_all_broad_themes', true) %}checked{% endif %}{% endif %}> Utiliser tous les th√®mes larges</label>
                            <!-- Debug: defaults={{ defaults }}, check_all_broad_themes={{ defaults.get('check_all_broad_themes', 'NOT_SET') }} -->
                            <div class="themes-grid-select" data-theme-relations='{
                                {% for theme in themes %}
                                "{{ theme.id }}": [
                                    {% set specific_ids = [] %}
                                    {% for st in specific_themes %}
                                    {% if st.broad_theme_id == theme.id %}
                                    {% set _ = specific_ids.append(st.id) %}
                                    {% endif %}
                                    {% endfor %}
                                    {% for id in specific_ids %}{{ id }}{% if not loop.last %}, {% endif %}{% endfor %}
                                ]{% if not loop.last %},{% endif %}
                                {% endfor %}
                            }'>
                                {% for theme in themes %}
                                <label class="chip"><input type="checkbox" name="allowed_broad_theme_ids" value="{{ theme.id }}" {% if rule %}{% if (not rule.use_all_broad_themes) and (theme in rule.allowed_broad_themes) %}checked{% endif %}{% else %}{% if defaults.get('check_all_broad_themes', true) %}checked{% endif %}{% endif %}> {% if theme.icon %}{{ theme.icon }} {% endif %}{{ theme.name }}</label>
                                {% endfor %}
                            </div>

                            <label class="checkbox-label"><input type="checkbox" id="use_all_specific_themes" name="use_all_specific_themes" {% if rule %}{% if rule.use_all_specific_themes %}checked{% endif %}{% else %}{% if defaults.get('use_all_specific_themes', true) %}checked{% endif %}{% endif %}> Utiliser tous les sous-th√®mes</label>
                            <div class="themes-grid-select">
                                {% for st in specific_themes %}
                                <label class="chip"><input type="checkbox" name="allowed_specific_theme_ids" value="{{ st.id }}" {% if rule %}{% if (not rule.use_all_specific_themes) and (st in rule.allowed_specific_themes) %}checked{% endif %}{% else %}{% if defaults.get('check_all_specific_themes', true) %}checked{% endif %}{% endif %}> {% if st.icon %}{{ st.icon }} {% endif %}{{ st.name }} ({{ st.broad_theme.name }})</label>
                                {% endfor %}
                            </div>

                            <!-- Compteur de questions -->
                            <div class="question-counter">
                                <div id="question-count" class="question-count-info">
                                    <span class="count-icon">üî¢</span>
                                    <span id="question-count-text">Calcul en cours...</span>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <div class="tab-actions">
                        <button type="button" class="btn btn-primary tab-next" data-next-tab="questions">Suivant ‚Üí</button>
                    </div>
                </div>

                <div class="tab-panel" data-tab="questions">
                    <div class="form-column">
                        <fieldset class="fieldset">
                            <legend>S√©lection des questions</legend>
                            
                            <div class="question-selection-info">
                                <p><strong>Instructions :</strong> S√©lectionnez les questions que vous souhaitez inclure dans ce quiz. Les questions affich√©es correspondent aux sous-th√®mes et difficult√©s s√©lectionn√©s dans les onglets pr√©c√©dents.</p>
                                <p><strong>Mode automatique :</strong> Si toutes les questions restent s√©lectionn√©es, le quiz utilisera automatiquement toutes les questions correspondant aux th√®mes et difficult√©s choisis (y compris les nouvelles questions ajout√©es ult√©rieurement).</p>
                                <p><strong>Mode manuel :</strong> Si vous d√©s√©lectionnez des questions, le quiz utilisera uniquement la liste sp√©cifique de questions que vous avez s√©lectionn√©es.</p>
            </div>

                            <div id="selection-mode-indicator" class="selection-mode-indicator">
                                <span class="mode-badge mode-auto">Mode: Automatique</span>
                                <span class="mode-description">Toutes les questions correspondant aux crit√®res seront utilis√©es</span>
                            </div>

                            <div id="questions-table-container">
                                <table class="questions-selection-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">
                                                <input type="checkbox" id="select-all-questions" title="Tout s√©lectionner / Tout d√©s√©lectionner">
                                            </th>
                                            <th style="width: 60px;">ID</th>
                                            <th>Question</th>
                                            <th style="width: 150px;">Th√®me large</th>
                                            <th style="width: 150px;">Sous-th√®me</th>
                                            <th style="width: 80px;">Difficult√©</th>
                                        </tr>
                                    </thead>
                                    <tbody id="questions-table-body">
                                        <tr>
                                            <td colspan="6" class="loading-message">
                                                Chargement des questions...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="questions-selection-summary">
                                <span id="selected-questions-count">0 question(s) s√©lectionn√©e(s)</span>
                            </div>
                        </fieldset>
                    </div>

                    <div class="tab-actions">
                        <button type="button" class="btn btn-primary tab-next" data-next-tab="timing">Suivant ‚Üí</button>
                    </div>
                </div>

                <!-- Modale de d√©tail de question -->
                <div id="question-detail-modal" class="question-modal hidden">
                    <div class="question-modal-overlay" onclick="closeQuestionDetailModal()"></div>
                    <div class="question-modal-content">
                        <div class="question-modal-header">
                            <h3>D√©tail de la question</h3>
                            <button type="button" class="btn-close" onclick="closeQuestionDetailModal()">‚úï</button>
                        </div>
                        <div class="question-modal-body" id="question-detail-body">
                            <div class="loading-message">Chargement...</div>
                        </div>
                    </div>
                </div>

                <div class="tab-panel" data-tab="timing">
            <div class="form-column">
                <fieldset class="fieldset">
                    <legend>Timer</legend>
                    <div class="form-group">
                        <label for="timer_seconds">Dur√©e par question (secondes)</label>
                                <input id="timer_seconds" name="timer_seconds" type="number" min="5" step="1" value="{{ rule.timer_seconds if rule else defaults.get('timer_seconds', 30) }}">
                    </div>
                </fieldset>

                <fieldset class="fieldset">
                    <legend>Difficult√©s utilis√©es</legend>
                    <div class="checkboxes-inline">
                                {% set selected = rule.get_allowed_difficulties() if rule else defaults.get('allowed_difficulties', [1,2,3,4,5]) %}
                        {% for d in [1,2,3,4,5] %}
                        <label><input type="checkbox" name="allowed_difficulties" value="{{ d }}" {% if d in selected %}checked{% endif %}> {{ d }}</label>
                        {% endfor %}
                    </div>
                    <div class="form-group">
                        <label>Nombre de questions par difficult√©</label>
                        <div class="grid-5">
                            {% for d in [1,2,3,4,5] %}
                            <div>
                                <label for="qpd{{ d }}" class="small">Diff {{ d }}</label>
                                        {% set qmap = rule.get_questions_per_difficulty() if rule else defaults.get('questions_per_difficulty', {}) %}
                                        <input id="qpd{{ d }}" name="questions_per_difficulty_{{ d }}" type="number" min="0" step="1" value="{{ qmap.get(d|string, '') }}">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </fieldset>
                    </div>

                    <div class="tab-actions">
                        <button type="button" class="btn btn-primary tab-next" data-next-tab="scoring">Suivant ‚Üí</button>
                    </div>
                </div>

                <div class="tab-panel" data-tab="scoring">
                    <div class="form-column">
                <fieldset class="fieldset">
                    <legend>Scoring</legend>
                    <div class="form-group">
                        <label for="scoring_base_points">Points par question</label>
                                <input id="scoring_base_points" name="scoring_base_points" type="number" min="0" step="1" value="{{ rule.scoring_base_points if rule else defaults.get('scoring_base_points', 10) }}">
                    </div>
                    <div class="form-group">
                        <label for="scoring_difficulty_bonus_type">Bonus difficult√©</label>
                        <select id="scoring_difficulty_bonus_type" name="scoring_difficulty_bonus_type">
                                    {% set s = rule.scoring_difficulty_bonus_type if rule else defaults.get('scoring_difficulty_bonus_type', 'add') %}
                            <option value="none" {% if s == 'none' %}selected{% endif %}>Aucun</option>
                            <option value="add" {% if s == 'add' %}selected{% endif %}>Addition (+N)</option>
                            <option value="mult" {% if s == 'mult' %}selected{% endif %}>Multiplicatif (√óN)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valeurs bonus par difficult√©</label>
                        <div class="grid-5">
                                    {% set bmap = rule.get_difficulty_bonus_map() if rule else defaults.get('difficulty_bonus_map', {}) %}
                            {% for d in [1,2,3,4,5] %}
                            <div>
                                <label for="bonus{{ d }}" class="small">Diff {{ d }}</label>
                                        <input id="bonus{{ d }}" name="difficulty_bonus_{{ d }}" type="number" step="0.1" value="{{ bmap.get(d|string, '') }}">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" name="combo_bonus_enabled" {% if rule %}{% if rule.combo_bonus_enabled %}checked{% endif %}{% else %}{% if defaults.get('combo_bonus_enabled', true) %}checked{% endif %}{% endif %}> Activer bonus de combo</label>
                        <div class="grid-2">
                            <div>
                                <label for="combo_step" class="small">Taille du palier</label>
                                        <input id="combo_step" name="combo_step" type="number" min="2" step="1" value="{{ rule.combo_step if rule else defaults.get('combo_step', 3) }}">
                            </div>
                            <div>
                                <label for="combo_bonus_points" class="small">Points par palier</label>
                                        <input id="combo_bonus_points" name="combo_bonus_points" type="number" min="0" step="1" value="{{ rule.combo_bonus_points if rule else defaults.get('combo_bonus_points', 5) }}">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="perfect_quiz_bonus">Bonus perfect</label>
                                <input id="perfect_quiz_bonus" name="perfect_quiz_bonus" type="number" min="0" step="1" value="{{ rule.perfect_quiz_bonus if rule else defaults.get('perfect_quiz_bonus', 50) }}">
                            </div>
                            <div class="form-group">
                                <label for="min_correct_answers_to_win">Nombre minimum de bonnes r√©ponses pour gagner</label>
                                <input id="min_correct_answers_to_win" name="min_correct_answers_to_win" type="number" min="0" step="1" value="{{ rule.min_correct_answers_to_win if rule else defaults.get('min_correct_answers_to_win', 0) }}" onchange="validateMinCorrectAnswers()">
                                <div class="small">0 = toujours gagn√© si le quiz est termin√©</div>
                                <div id="min-answers-warning" class="field-error" style="display: none;"></div>
                            </div>

                            <!-- R√©sum√© score maximum -->
                            <div class="score-summary">
                                <div class="score-line">
                                    Score max th√©orique: <strong id="max-score-value">0</strong> points
                                </div>
                                <div id="max-score-breakdown" class="score-breakdown small"></div>
                            </div>
                        </fieldset>
                    </div>

                    <div class="tab-actions">
                        <button type="button" class="btn btn-primary tab-next" data-next-tab="messages">Suivant ‚Üí</button>
                    </div>
                </div>

                <div class="tab-panel" data-tab="messages">
                    <div class="form-column">
                <fieldset class="fieldset">
                    <legend>Messages</legend>
                    <div class="form-group">
                        <label for="intro_message">Message d'introduction</label>
                                <textarea id="intro_message" name="intro_message" rows="2">{{ rule.intro_message if rule else defaults.get('intro_message', '') }}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="intro_image_id">Image du message d'introduction (optionnel)</label>
                                <div class="input-with-action">
                                <select id="intro_image_id" name="intro_image_id" class="answer-image-select"
                                        onchange="(function(sel){
                                            var opt = sel.options[sel.selectedIndex];
                                            var prev = document.getElementById('intro-image-preview');
                                            var img = document.getElementById('intro-image-thumb');
                                            var hasImg = opt && opt.value && opt.dataset && opt.dataset.filename;
                                            if (hasImg) {
                                                img.src = '/uploads/' + opt.dataset.filename;
                                                img.alt = opt.dataset.alt || '';
                                                prev.style.display = 'inline-block';
                                            } else {
                                                prev.style.display = 'none';
                                            }
                                        })(this)">
                                    <option value="">-- Pas d'image --</option>
                                    {% for img in images %}
                                    <option value="{{ img.id }}" data-filename="{{ img.filename }}" data-alt="{{ (img.alt_text or img.title) | e }}"
                                        {% if rule and rule.intro_image_id == img.id %}selected{% endif %}>
                                        {{ img.title }} ({{ img.filename }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-small" onclick="openEmbeddedImageModal('intro_image_id')">+ Ajouter une image</button>
                                <button type="button" class="btn btn-small btn-outline" onclick="refreshImageSelects()" title="Rafra√Æchir la liste des images">‚Üª</button>
                                </div>
                                <div id="intro-image-preview" class="image-preview" style="{% if rule and rule.intro_image %}display: inline-block;{% else %}display: none;{% endif %}">
                                    <img id="intro-image-thumb" src="{% if rule and rule.intro_image %}/uploads/{{ rule.intro_image.filename }}{% endif %}" alt="Aper√ßu">
                                </div>
                                <small><a href="/images" target="_blank" style="color: var(--primary-color)">‚Üí G√©rer les images</a></small>
                    </div>
                    <div class="form-group">
                        <label for="success_message">Message de r√©ussite</label>
                                <textarea id="success_message" name="success_message" rows="2">{{ rule.success_message if rule else defaults.get('success_message', '') }}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="success_image_id">Image du message de r√©ussite (optionnel)</label>
                                <div class="input-with-action">
                                <select id="success_image_id" name="success_image_id" class="answer-image-select"
                                        onchange="(function(sel){
                                            var opt = sel.options[sel.selectedIndex];
                                            var prev = document.getElementById('success-image-preview');
                                            var img = document.getElementById('success-image-thumb');
                                            var hasImg = opt && opt.value && opt.dataset && opt.dataset.filename;
                                            if (hasImg) {
                                                img.src = '/uploads/' + opt.dataset.filename;
                                                img.alt = opt.dataset.alt || '';
                                                prev.style.display = 'inline-block';
                                            } else {
                                                prev.style.display = 'none';
                                            }
                                        })(this)">
                                    <option value="">-- Pas d'image --</option>
                                    {% for img in images %}
                                    <option value="{{ img.id }}" data-filename="{{ img.filename }}" data-alt="{{ (img.alt_text or img.title) | e }}"
                                        {% if rule and rule.success_image_id == img.id %}selected{% endif %}>
                                        {{ img.title }} ({{ img.filename }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-small" onclick="openEmbeddedImageModal('success_image_id')">+ Ajouter une image</button>
                                <button type="button" class="btn btn-small btn-outline" onclick="refreshImageSelects()" title="Rafra√Æchir la liste des images">‚Üª</button>
                                </div>
                                <div id="success-image-preview" class="image-preview" style="{% if rule and rule.success_image %}display: inline-block;{% else %}display: none;{% endif %}">
                                    <img id="success-image-thumb" src="{% if rule and rule.success_image %}/uploads/{{ rule.success_image.filename }}{% endif %}" alt="Aper√ßu">
                                </div>
                                <small><a href="/images" target="_blank" style="color: var(--primary-color)">‚Üí G√©rer les images</a></small>
                            </div>
                            <div class="form-group">
                                <label for="failure_message">Message d'√©chec</label>
                                <textarea id="failure_message" name="failure_message" rows="2">{{ rule.failure_message if rule else defaults.get('failure_message', '') }}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="failure_image_id">Image du message d'√©chec (optionnel)</label>
                                <div class="input-with-action">
                                <select id="failure_image_id" name="failure_image_id" class="answer-image-select"
                                        onchange="(function(sel){
                                            var opt = sel.options[sel.selectedIndex];
                                            var prev = document.getElementById('failure-image-preview');
                                            var img = document.getElementById('failure-image-thumb');
                                            var hasImg = opt && opt.value && opt.dataset && opt.dataset.filename;
                                            if (hasImg) {
                                                img.src = '/uploads/' + opt.dataset.filename;
                                                img.alt = opt.dataset.alt || '';
                                                prev.style.display = 'inline-block';
                                            } else {
                                                prev.style.display = 'none';
                                            }
                                        })(this)">
                                    <option value="">-- Pas d'image --</option>
                                    {% for img in images %}
                                    <option value="{{ img.id }}" data-filename="{{ img.filename }}" data-alt="{{ (img.alt_text or img.title) | e }}"
                                        {% if rule and rule.failure_image_id == img.id %}selected{% endif %}>
                                        {{ img.title }} ({{ img.filename }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-small" onclick="openEmbeddedImageModal('failure_image_id')">+ Ajouter une image</button>
                                <button type="button" class="btn btn-small btn-outline" onclick="refreshImageSelects()" title="Rafra√Æchir la liste des images">‚Üª</button>
                                </div>
                                <div id="failure-image-preview" class="image-preview" style="{% if rule and rule.failure_image %}display: inline-block;{% else %}display: none;{% endif %}">
                                    <img id="failure-image-thumb" src="{% if rule and rule.failure_image %}/uploads/{{ rule.failure_image.filename }}{% endif %}" alt="Aper√ßu">
                                </div>
                                <small><a href="/images" target="_blank" style="color: var(--primary-color)">‚Üí G√©rer les images</a></small>
                            </div>
                        </fieldset>
                    </div>

                    <div class="tab-actions">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('rule-form-container').classList.add('hidden')">Annuler</button>
                        <button type="submit" class="btn btn-primary">{% if rule %}Mettre √† jour{% else %}Cr√©er{% endif %}</button>
                    </div>
                </div>
            </div>
        </div>

    </form>
</div>

<script>
// Soumission manuelle du formulaire embarqu√© pour √©viter TOUT rafra√Æchissement
function submitEmbeddedImageForm(formEl){
    var url = formEl.getAttribute('action');
    var formData = new FormData(formEl);
    formData.set('embedded','1');
    // select_id transmis depuis champ hidden
    var selectId = formEl.querySelector('input[name="select_id"]').value || '';
    console.log('[submitEmbeddedImageForm] submitting to:', url, 'with selectId:', selectId);
    fetch(url, { method: 'POST', body: formData, headers: { 'HX-Request': 'true' }})
      .then(function(r){
          console.log('[submitEmbeddedImageForm] response status:', r.status);
          if (!r.ok) throw new Error('Erreur HTTP ' + r.status);
          return r.json();
      })
      .then(function(json){
          console.log('[submitEmbeddedImageForm] received JSON:', json);
          if (json && json.created_image){
              console.log('[submitEmbeddedImageForm] calling onEmbeddedImageCreated with:', json.created_image, json.select_id || selectId);
              if (window.onEmbeddedImageCreated){
                  window.onEmbeddedImageCreated(json.created_image, json.select_id || selectId);
              }
              // Fermer la modale - retir√© car d√©j√† fait dans onEmbeddedImageCreated
          }
      })
      .catch(function(err){
          console.error('Erreur lors de la cr√©ation d\'image:', err);
          alert('Erreur lors de la cr√©ation de l\'image: ' + err.message);
      });
    return false; // Emp√™cher la soumission par d√©faut du formulaire
}
// Ouvrir une modale embarqu√©e pour cr√©er une image, au-dessus de la modale des r√®gles
function openEmbeddedImageModal(selectId) {
    // Cr√©er un conteneur overlay si absent
    var overlay = document.getElementById('embedded-image-modal');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'embedded-image-modal';
        overlay.className = 'modal-overlay';
        overlay.innerHTML = '<div class="modal-content"><div id="embedded-image-form-wrapper"></div></div>';
        document.body.appendChild(overlay);
    }
    overlay.style.display = 'flex';
    // Charger le formulaire d'image en mode embarqu√©
    fetch('/image/new?embedded=1&select_id=' + encodeURIComponent(selectId), { headers: { 'HX-Request': 'true' }})
      .then(function(r){return r.text()})
      .then(function(html){
        var wrap = document.getElementById('embedded-image-form-wrapper');
        wrap.innerHTML = html;
      });
}

function closeEmbeddedImageModal() {
    var overlay = document.getElementById('embedded-image-modal');
    if (overlay) overlay.style.display = 'none';
}

// Callback appel√© par le formulaire d'image embarqu√© apr√®s cr√©ation
window.onEmbeddedImageCreated = function(createdImage, selectId){
    console.log('[onEmbeddedImageCreated] called with:', createdImage, 'selectId:', selectId);
    try {
        var sel = document.getElementById(selectId);
        console.log('[onEmbeddedImageCreated] found select element:', sel);
        if (!sel) {
            console.error('[onEmbeddedImageCreated] Select element not found for id:', selectId);
            return;
        }
        // Ajouter l'option si absente
        var existing = Array.prototype.some.call(sel.options, function(o){ return String(o.value) === String(createdImage.id); });
        console.log('[onEmbeddedImageCreated] image already exists:', existing);
        if (!existing) {
            var opt = document.createElement('option');
            opt.value = String(createdImage.id);
            opt.textContent = createdImage.title + ' (' + createdImage.filename + ')';
            opt.setAttribute('data-filename', createdImage.filename || '');
            opt.setAttribute('data-alt', createdImage.alt_text || createdImage.title || '');
            sel.appendChild(opt);
            console.log('[onEmbeddedImageCreated] option added');
        }
        // S√©lectionner la nouvelle image
        sel.value = String(createdImage.id);
        console.log('[onEmbeddedImageCreated] selected value set to:', sel.value);
        // D√©clencher l'√©v√©nement change pour rafra√Æchir l'aper√ßu
        var event = new Event('change', { bubbles: true });
        sel.dispatchEvent(event);
        console.log('[onEmbeddedImageCreated] change event dispatched');
        // Fermer la modale embarqu√©e
        closeEmbeddedImageModal();
    } catch (e) {
        console.error('[onEmbeddedImageCreated] error:', e);
        closeEmbeddedImageModal();
    }
}

// Fonction pour rafra√Æchir tous les selects d'images de la page
function refreshImageSelects() {
    // Faire un appel √† une API JSON pour obtenir les donn√©es des images
    fetch('/api/images/json', { headers: { 'HX-Request': 'true' } })
        .then(function(r) {
            if (!r.ok) throw new Error('Erreur HTTP ' + r.status);
            return r.json();
        })
        .then(function(images) {
            // Mettre √† jour tous les selects d'images
            var imageSelects = document.querySelectorAll('select.answer-image-select');
            imageSelects.forEach(function(sel) {
                var currentValue = sel.value;

                // Garder seulement l'option "Pas d'image"
                var noImageOption = sel.querySelector('option[value=""]');
                sel.innerHTML = '';
                if (noImageOption) {
                    sel.appendChild(noImageOption.cloneNode(true));
                } else {
                    var defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '-- Pas d\'image --';
                    sel.appendChild(defaultOption);
                }

                // Ajouter toutes les options d'images
                images.forEach(function(img) {
                    var opt = document.createElement('option');
                    opt.value = img.id;
                    opt.textContent = img.title + ' (' + img.filename + ')';
                    opt.setAttribute('data-filename', img.filename);
                    opt.setAttribute('data-alt', img.alt_text || img.title);
                    sel.appendChild(opt);
                });

                // Restaurer la s√©lection pr√©c√©dente si elle existe encore
                if (currentValue && sel.querySelector('option[value="' + currentValue + '"]')) {
                    sel.value = currentValue;
                }

                // D√©clencher l'√©v√©nement change pour rafra√Æchir l'aper√ßu
                var event = new Event('change', { bubbles: true });
                sel.dispatchEvent(event);
            });

            // Message de confirmation
            showToast('Liste des images mise √† jour', 'success');
        })
        .catch(function(err) {
            console.error('Erreur lors du rafra√Æchissement des images:', err);
            showToast('Erreur lors du rafra√Æchissement: ' + err.message, 'error');
        });
}

// Fonction utilitaire pour afficher des messages toast
function showToast(message, type) {
    // Cr√©er un √©l√©ment toast temporaire
    var toast = document.createElement('div');
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: ' +
        (type === 'success' ? '#10b981' : '#ef4444') +
        '; color: white; padding: 12px 16px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 9999; font-size: 14px; max-width: 300px;';
    toast.textContent = message;
    document.body.appendChild(toast);

    // Supprimer automatiquement apr√®s 3 secondes
    setTimeout(function() {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}
// Fonctions pour g√©rer les pays
function toggleCountryCheckboxes(checkbox) {
    const countryCheckboxes = document.querySelectorAll('input[name="allowed_country_ids"]');

    if (checkbox.checked) {
        // Si on coche "Tous les pays", on coche tous les pays individuels
        countryCheckboxes.forEach(cb => {
            cb.checked = true;
        });
    } else {
        // Si on d√©coche "Tous les pays", on d√©coche tous les pays individuels
        // pour forcer l'utilisateur √† s√©lectionner explicitement ceux qu'il veut
        countryCheckboxes.forEach(cb => {
            cb.checked = false;
        });
    }

    updateQuestionCount();
    loadQuestionsForSelection();
}

function updateUseAllCountries() {
    const useAllCheckbox = document.getElementById('use_all_countries');
    const countryCheckboxes = document.querySelectorAll('input[name="allowed_country_ids"]');
    const checkedBoxes = document.querySelectorAll('input[name="allowed_country_ids"]:checked');

    // Si tous les pays sont coch√©s, cocher "Tous les pays"
    if (checkedBoxes.length === countryCheckboxes.length) {
        useAllCheckbox.checked = true;
    } else {
        useAllCheckbox.checked = false;
    }
    updateQuestionCount();
    loadQuestionsForSelection();
}

let autoGeneratedSlug = '{{ rule.slug if rule and rule.slug else "" }}'; // Slug initial ou g√©n√©r√© automatiquement

function slugify(text) {
    // Normalisation basique des accents
    const accentMap = {
        '√†': 'a', '√¢': 'a', '√§': 'a', '√©': 'e', '√®': 'e', '√™': 'e', '√´': 'e',
        '√Ø': 'i', '√Æ': 'i', '√¥': 'o', '√∂': 'o', '√π': 'u', '√ª': 'u', '√º': 'u',
        '√ø': 'y', '√±': 'n', '√ß': 'c'
    };

    return text
        .toLowerCase()
        .trim()
        .replace(/[√†√¢√§√©√®√™√´√Ø√Æ√¥√∂√π√ª√º√ø√±√ß]/g, char => accentMap[char] || char)
        .replace(/[^a-z0-9\s\-_]/g, '') // Supprimer les caract√®res sp√©ciaux restants
        .replace(/[\s\-_]+/g, '-') // Remplacer espaces/tirets/underscores multiples par un seul tiret
        .replace(/^-+|-+$/g, ''); // Supprimer les tirets au d√©but et √† la fin
}

function checkRuleName(input) {
    const name = input.value.trim();
    const excludeId = '{{ rule.id if rule else "" }}';
    const errorDiv = document.getElementById('name-error');

    if (!name) {
        errorDiv.innerHTML = '';
        return;
    }

    // Afficher un indicateur de chargement
    errorDiv.innerHTML = '<span style="color: #666;">V√©rification...</span>';

    const params = new URLSearchParams({
        name: name,
        exclude_id: excludeId || ''
    });

    fetch(`/api/quiz-rule/check-name?${params}`)
        .then(response => response.text())
        .then(html => {
            errorDiv.innerHTML = html;
            // Si le nom est disponible, r√©g√©n√©rer automatiquement le slug si n√©cessaire
            if (html.includes('est disponible')) {
                const slugInput = document.getElementById('slug');
                const newSlug = slugify(name);

                // R√©g√©n√©rer le slug seulement si l'utilisateur n'a pas fait de modification manuelle
                // ou si le slug actuel est vide
                if (!slugInput.value.trim() || slugInput.value === autoGeneratedSlug) {
                    autoGeneratedSlug = newSlug;
                    slugInput.value = newSlug;
                    // V√©rifier automatiquement le slug g√©n√©r√©
                    checkRuleSlug(slugInput);
                }
            }
        })
        .catch(error => {
            console.error('Erreur lors de la v√©rification:', error);
            errorDiv.innerHTML = '<span style="color: #dc3545;">Erreur de v√©rification</span>';
        });
}

function handleSlugInput(input) {
    // Si l'utilisateur modifie manuellement le slug, marquer qu'il n'est plus auto-g√©n√©r√©
    const currentValue = input.value.trim();
    if (currentValue !== autoGeneratedSlug) {
        // L'utilisateur a fait une modification manuelle
        // On ne change pas autoGeneratedSlug ici, mais on indique que c'est modifi√© manuellement
    }
}

function updateQuestionCount() {
    // R√©cup√©rer les pays coch√©s (si "Tous les pays" n'est pas coch√©)
    const useAllCountries = document.getElementById('use_all_countries').checked;
    const selectedCountries = useAllCountries ? [] : Array.from(document.querySelectorAll('input[name="allowed_country_ids"]:checked'))
        .map(cb => parseInt(cb.value));

    // R√©cup√©rer les sous-th√®mes coch√©s
    const selectedSpecificThemes = Array.from(document.querySelectorAll('input[name="allowed_specific_theme_ids"]:checked'))
        .map(cb => parseInt(cb.value));

    // R√©cup√©rer les difficult√©s coch√©es
    const selectedDifficulties = Array.from(document.querySelectorAll('input[name="allowed_difficulties"]:checked'))
        .map(cb => parseInt(cb.value));

    const countText = document.getElementById('question-count-text');
    const countContainer = document.getElementById('question-count');

    if (selectedSpecificThemes.length === 0 || selectedDifficulties.length === 0) {
        countText.textContent = 'S√©lectionnez au moins un sous-th√®me et une difficult√©';
        countContainer.style.backgroundColor = '#fff3cd';
        return;
    }

    // Construire les param√®tres pour la requ√™te
    const params = new URLSearchParams();
    if (!useAllCountries) {
        // Quand "Tous les pays" n'est pas coch√©, on passe toujours country_ids[],
        // m√™me si vide (ce qui signifie "aucun pays s√©lectionn√© = 0 questions")
        selectedCountries.forEach(id => params.append('country_ids[]', id));
        // Ajouter un param√®tre pour indiquer qu'on veut filtrer par pays
        params.append('filter_by_countries', '1');
    }
    selectedSpecificThemes.forEach(id => params.append('specific_theme_ids[]', id));
    selectedDifficulties.forEach(level => params.append('difficulty_levels[]', level));

    fetch(`/api/quiz-rule/count-questions?${params}`)
        .then(response => response.json())
        .then(data => {
            countText.textContent = data.message;
            if (data.count === 0) {
                countContainer.style.backgroundColor = '#f8d7da';
            } else if (data.count < 10) {
                countContainer.style.backgroundColor = '#fff3cd';
            } else {
                countContainer.style.backgroundColor = '#d1ecf1';
            }
        })
        .catch(error => {
            console.error('Erreur lors du comptage:', error);
            countText.textContent = 'Erreur de calcul';
            countContainer.style.backgroundColor = '#f8d7da';
        });
}

// Calcul du nombre total de questions dans le quiz
function getTotalQuestionCount() {
    let total = 0;
    // Difficult√©s s√©lectionn√©es
    const selectedDifficulties = Array.from(document.querySelectorAll('input[name="allowed_difficulties"]:checked'))
        .map(cb => parseInt(cb.value));

    // Nombre de questions par difficult√©
    selectedDifficulties.forEach(d => {
        const el = document.getElementById(`qpd${d}`);
        const n = el ? parseInt(el.value || '0', 10) : 0;
        total += isNaN(n) ? 0 : n;
    });

    return total;
}

// Validation du nombre minimum de bonnes r√©ponses
function validateMinCorrectAnswers() {
    const minAnswersEl = document.getElementById('min_correct_answers_to_win');
    const minAnswers = minAnswersEl ? parseInt(minAnswersEl.value || '0', 10) : 0;
    const totalQuestions = getTotalQuestionCount();

    const warningEl = document.getElementById('min-answers-warning');
    const submitBtn = document.querySelector('form button[type="submit"]');

    if (minAnswers > totalQuestions && totalQuestions > 0) {
        // Afficher l'avertissement
        if (warningEl) {
            warningEl.textContent = `Attention : ${minAnswers} bonnes r√©ponses requises mais seulement ${totalQuestions} questions disponibles.`;
            warningEl.style.display = 'block';
        }
        // D√©sactiver le bouton de sauvegarde
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.6';
        }
    } else {
        // Masquer l'avertissement
        if (warningEl) {
            warningEl.style.display = 'none';
        }
        // R√©activer le bouton de sauvegarde
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
        }
    }
}

// Calcul du score maximum th√©orique (sans-faute)
function computeMaxScore() {
    // Difficult√©s s√©lectionn√©es
    const selectedDifficulties = Array.from(document.querySelectorAll('input[name="allowed_difficulties"]:checked'))
        .map(cb => parseInt(cb.value));

    // Nombre de questions par difficult√©
    const questionsPerDifficulty = {};
    let totalQuestions = 0;
    selectedDifficulties.forEach(d => {
        const el = document.getElementById(`qpd${d}`);
        const n = el ? parseInt(el.value || '0', 10) : 0;
        questionsPerDifficulty[d] = isNaN(n) ? 0 : n;
        totalQuestions += questionsPerDifficulty[d];
    });

    // Param√®tres de scoring
    const basePointsEl = document.getElementById('scoring_base_points');
    const basePoints = basePointsEl ? parseFloat(basePointsEl.value || '0') : 0;

    const bonusTypeEl = document.getElementById('scoring_difficulty_bonus_type');
    const bonusType = bonusTypeEl ? bonusTypeEl.value : 'none'; // none | add | mult

    const bonusMap = {};
    selectedDifficulties.forEach(d => {
        const el = document.getElementById(`bonus${d}`);
        const v = el ? parseFloat(el.value || (bonusType === 'mult' ? '1' : '0')) : (bonusType === 'mult' ? 1 : 0);
        bonusMap[d] = isNaN(v) ? (bonusType === 'mult' ? 1 : 0) : v;
    });

    // Calcul des points li√©s aux questions
    let questionsPoints = 0;
    const breakdownParts = [];
    selectedDifficulties.forEach(d => {
        const num = questionsPerDifficulty[d];
        if (!num) return;
        let perQuestion = basePoints;
        if (bonusType === 'add') perQuestion = basePoints + (bonusMap[d] || 0);
        else if (bonusType === 'mult') perQuestion = basePoints * (bonusMap[d] || 1);
        const subtotal = perQuestion * num;
        questionsPoints += subtotal;
        breakdownParts.push(`D${d}: ${num}√ó${perQuestion}${bonusType!=='none' ? '' : ''} = ${Math.round(subtotal)}`);
    });

    // Bonus combo
    const comboEnabled = document.querySelector('input[name="combo_bonus_enabled"]')?.checked;
    let comboBonus = 0;
    if (comboEnabled && totalQuestions > 0) {
        const stepEl = document.getElementById('combo_step');
        const pointsEl = document.getElementById('combo_bonus_points');
        const step = stepEl ? parseInt(stepEl.value || '0', 10) : 0;
        const pts = pointsEl ? parseInt(pointsEl.value || '0', 10) : 0;
        if (step > 0 && pts > 0) {
            comboBonus = Math.floor(totalQuestions / step) * pts;
        }
    }

    // Bonus perfect
    const perfectEl = document.getElementById('perfect_quiz_bonus');
    const perfectBonus = perfectEl ? parseInt(perfectEl.value || '0', 10) : 0;

    const total = Math.round(questionsPoints + comboBonus + perfectBonus);

    const outEl = document.getElementById('max-score-value');
    if (outEl) outEl.textContent = `${total}`;
    const breakdownEl = document.getElementById('max-score-breakdown');
    if (breakdownEl) {
        const parts = [];
        if (breakdownParts.length) parts.push(`Questions: ${Math.round(questionsPoints)} (${breakdownParts.join(', ')})`);
        if (comboBonus) parts.push(`Combo: +${comboBonus}`);
        if (perfectBonus) parts.push(`Perfect: +${perfectBonus}`);
        breakdownEl.textContent = parts.length ? parts.join(' | ') : '‚Äî';
    }

    // Valider le nombre minimum de bonnes r√©ponses apr√®s recalcul du score
    validateMinCorrectAnswers();
}

function checkRuleSlug(input) {
    const slug = input.value.trim();
    const excludeId = '{{ rule.id if rule else "" }}';
    const errorDiv = document.getElementById('slug-error');

    if (!slug) {
        errorDiv.innerHTML = '';
        return;
    }

    // Afficher un indicateur de chargement
    errorDiv.innerHTML = '<span style="color: #666;">V√©rification...</span>';

    const params = new URLSearchParams({
        slug: slug,
        exclude_id: excludeId || ''
    });

    fetch(`/api/quiz-rule/check-slug?${params}`)
        .then(response => response.text())
        .then(html => {
            errorDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Erreur lors de la v√©rification:', error);
            errorDiv.innerHTML = '<span style="color: #dc3545;">Erreur de v√©rification</span>';
        });
}

// Gestion de la concordance des checkboxes de th√®mes
function initThemeCheckboxes() {
    console.log('Initialisation des checkboxes de th√®mes...');

    // R√©cup√©rer les relations depuis l'attribut data
    const themesGrid = document.querySelector('.themes-grid-select');
    const themeRelations = JSON.parse(themesGrid.dataset.themeRelations || '{}');

    console.log('Relations th√®mes:', themeRelations);

    // Flag pour √©viter les boucles infinies
    let isUpdating = false;

    // Th√®mes larges
    const useAllBroadThemes = document.getElementById('use_all_broad_themes');
    const broadThemeCheckboxes = document.querySelectorAll('input[name="allowed_broad_theme_ids"]');

    console.log('useAllBroadThemes:', useAllBroadThemes);
    console.log('broadThemeCheckboxes:', broadThemeCheckboxes.length, 'trouv√©s');

    // Sous-th√®mes
    const useAllSpecificThemes = document.getElementById('use_all_specific_themes');
    const specificThemeCheckboxes = document.querySelectorAll('input[name="allowed_specific_theme_ids"]');

    // Difficult√©s
    const difficultyCheckboxes = document.querySelectorAll('input[name="allowed_difficulties"]');

    console.log('useAllSpecificThemes:', useAllSpecificThemes);
    console.log('specificThemeCheckboxes:', specificThemeCheckboxes.length, 'trouv√©s');

    // Fonction pour v√©rifier si tous les th√®mes larges sont coch√©s
    function checkAllBroadThemesChecked() {
        const checkedCount = Array.from(broadThemeCheckboxes).filter(cb => cb.checked).length;
        const totalCount = broadThemeCheckboxes.length;
        return checkedCount === totalCount && totalCount > 0;
    }

    // Fonction pour v√©rifier si tous les sous-th√®mes sont coch√©s
    function checkAllSpecificThemesChecked() {
        const checkedCount = Array.from(specificThemeCheckboxes).filter(cb => cb.checked).length;
        const totalCount = specificThemeCheckboxes.length;
        return checkedCount === totalCount && totalCount > 0;
    }

    // Gestionnaire pour "Utiliser tous les th√®mes larges"
    useAllBroadThemes?.addEventListener('change', function() {
        if (isUpdating) return;
        isUpdating = true;
        console.log('Changement de "Utiliser tous les th√®mes larges":', this.checked);
        broadThemeCheckboxes.forEach(cb => {
            cb.checked = this.checked;
            // D√©clencher manuellement l'√©v√©nement change pour synchroniser les sous-th√®mes
            cb.dispatchEvent(new Event('change', { bubbles: true }));
        });
        // Mettre √† jour le compteur de questions
        updateQuestionCount();
        // Recalculer le score maximum
        computeMaxScore();
        isUpdating = false;
    });

    // Gestionnaire pour "Utiliser tous les sous-th√®mes"
    useAllSpecificThemes?.addEventListener('change', function() {
        if (isUpdating) return;
        isUpdating = true;
        console.log('Changement de "Utiliser tous les sous-th√®mes":', this.checked);
        specificThemeCheckboxes.forEach(cb => {
            cb.checked = this.checked;
        });
        // Mettre √† jour le compteur de questions
        updateQuestionCount();
        // Recalculer le score maximum
        computeMaxScore();
        isUpdating = false;
    });

    // Gestionnaire pour les th√®mes larges individuels
    broadThemeCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            if (isUpdating) return; // √âviter les boucles
            isUpdating = true;

            const broadThemeId = this.value;
            const relatedSpecificThemeIds = themeRelations[broadThemeId] || [];

            console.log('Changement th√®me large:', broadThemeId, 'coche:', this.checked, 'sous-th√®mes:', relatedSpecificThemeIds);

            // Synchroniser les sous-th√®mes correspondants
            relatedSpecificThemeIds.forEach(specificThemeId => {
                const specificCheckbox = document.querySelector(`input[name="allowed_specific_theme_ids"][value="${specificThemeId}"]`);
                if (specificCheckbox) {
                    specificCheckbox.checked = this.checked;
                    console.log('Sous-th√®me', specificThemeId, 'mis √†', this.checked);
                }
            });

            // V√©rifier l'√©tat de "Utiliser tous les th√®mes larges"
            if (useAllBroadThemes) {
                useAllBroadThemes.checked = checkAllBroadThemesChecked();
            }

            // Si on d√©coche un th√®me large, d√©cocher aussi "Utiliser tous les sous-th√®mes"
            // car tous les sous-th√®mes ne sont plus utilis√©s
            if (!this.checked && useAllSpecificThemes) {
                useAllSpecificThemes.checked = false;
                console.log('D√©coche "Utiliser tous les sous-th√®mes" car th√®me large d√©coch√©');
            }

            // Mettre √† jour le compteur de questions
            updateQuestionCount();
            // Recalculer le score maximum
            computeMaxScore();

            isUpdating = false;
        });
    });

    // Gestionnaire pour les sous-th√®mes individuels
    specificThemeCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            if (isUpdating) return; // √âviter les boucles
            isUpdating = true;

            const specificThemeId = parseInt(this.value);

            console.log('Changement sous-th√®me:', specificThemeId, 'coche:', this.checked);

            // Trouver le th√®me large parent
            let parentBroadThemeId = null;
            for (const [broadId, specificIds] of Object.entries(themeRelations)) {
                if (specificIds.includes(specificThemeId)) {
                    parentBroadThemeId = broadId;
                    break;
                }
            }

            if (parentBroadThemeId) {
                const parentBroadCheckbox = document.querySelector(`input[name="allowed_broad_theme_ids"][value="${parentBroadThemeId}"]`);

                if (this.checked) {
                    // Si on coche un sous-th√®me, cocher automatiquement le th√®me large parent
                    if (parentBroadCheckbox) {
                        parentBroadCheckbox.checked = true;
                        console.log('Th√®me large parent', parentBroadThemeId, 'coch√© car sous-th√®me coch√©');
                    }
                } else {
                    // Si on d√©coche un sous-th√®me, ne d√©cocher le th√®me large parent
                    // que si TOUS les autres sous-th√®mes sont aussi d√©coch√©s
                    const parentSpecificIds = themeRelations[parentBroadThemeId] || [];
                    const anyParentSpecificChecked = parentSpecificIds.some(id => {
                        const checkbox = document.querySelector(`input[name="allowed_specific_theme_ids"][value="${id}"]`);
                        return checkbox && checkbox.checked;
                    });

                    // Ne d√©cocher que si AUCUN sous-th√®me n'est coch√©
                    if (parentBroadCheckbox && !anyParentSpecificChecked) {
                        parentBroadCheckbox.checked = false;
                        console.log('Th√®me large parent', parentBroadThemeId, 'd√©coch√© car tous les sous-th√®mes sont d√©coch√©s');
                    }
                }
            }

            // V√©rifier l'√©tat de "Utiliser tous les sous-th√®mes"
            if (useAllSpecificThemes) {
                useAllSpecificThemes.checked = checkAllSpecificThemesChecked();
            }

            // Mettre √† jour le compteur de questions
            updateQuestionCount();
            // Recalculer le score maximum
            computeMaxScore();

            isUpdating = false;
        });
    });

    // Gestionnaire pour les difficult√©s
    difficultyCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            console.log('Changement difficult√©:', this.value, 'coche:', this.checked);
            // Mettre √† jour le compteur de questions
            updateQuestionCount();
            // Recalculer le score maximum
            computeMaxScore();
            // Revalider le nombre minimum de bonnes r√©ponses
            validateMinCorrectAnswers();
        });
    });

    // Gestionnaire pour les champs "questions par difficult√©"
    [1, 2, 3, 4, 5].forEach(d => {
        const el = document.getElementById(`qpd${d}`);
        if (el) {
            el.addEventListener('input', function() {
                console.log('Changement qpd' + d + ':', this.value);
                // Recalculer le score maximum
                computeMaxScore();
                // Revalider le nombre minimum de bonnes r√©ponses
                validateMinCorrectAnswers();
            });
        }
    });

    // Initialisation : synchroniser les checkboxes enfants avec leur parent
    if (useAllBroadThemes) {
        if (useAllBroadThemes.checked) {
            // Si le parent est coch√©, cocher tous les enfants
            broadThemeCheckboxes.forEach(cb => {
                cb.checked = true;
            });
        } else {
            // Si le parent n'est pas coch√©, v√©rifier si tous les enfants sont coch√©s
            useAllBroadThemes.checked = checkAllBroadThemesChecked();
        }
    }

    if (useAllSpecificThemes) {
        if (useAllSpecificThemes.checked) {
            // Si le parent est coch√©, cocher tous les enfants
            specificThemeCheckboxes.forEach(cb => {
                cb.checked = true;
            });
        } else {
            // Si le parent n'est pas coch√©, v√©rifier si tous les enfants sont coch√©s
            useAllSpecificThemes.checked = checkAllSpecificThemesChecked();
        }
    }

    // Initialisation pour les pays : synchroniser avec le parent
    const useAllCountries = document.getElementById('use_all_countries');
    if (useAllCountries) {
        if (useAllCountries.checked) {
            // Si le parent est coch√©, cocher tous les enfants
            document.querySelectorAll('input[name="allowed_country_ids"]').forEach(cb => {
                cb.checked = true;
            });
        } else {
            // Si le parent n'est pas coch√©, v√©rifier si tous les enfants sont coch√©s
            updateUseAllCountries();
        }
    }

    // Calcul initial du nombre de questions
    updateQuestionCount();
    // Calcul initial du score maximum
    computeMaxScore();
    // Validation initiale du nombre minimum de bonnes r√©ponses
    validateMinCorrectAnswers();
}

// Charger les questions disponibles pour la s√©lection
function loadQuestionsForSelection() {
    // R√©cup√©rer les pays coch√©s (si "Tous les pays" n'est pas coch√©)
    const useAllCountries = document.getElementById('use_all_countries').checked;
    const selectedCountries = useAllCountries ? [] : Array.from(document.querySelectorAll('input[name="allowed_country_ids"]:checked'))
        .map(cb => parseInt(cb.value));

    // R√©cup√©rer les sous-th√®mes coch√©s
    const selectedSpecificThemes = Array.from(document.querySelectorAll('input[name="allowed_specific_theme_ids"]:checked'))
        .map(cb => parseInt(cb.value));

    // R√©cup√©rer les difficult√©s coch√©es
    const selectedDifficulties = Array.from(document.querySelectorAll('input[name="allowed_difficulties"]:checked'))
        .map(cb => parseInt(cb.value));

    const tableBody = document.getElementById('questions-table-body');

    if (selectedSpecificThemes.length === 0 || selectedDifficulties.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="no-questions-message">Veuillez s√©lectionner au moins un sous-th√®me et une difficult√© dans les onglets pr√©c√©dents.</td></tr>';
        updateSelectedQuestionsCount();
        return;
    }

    // Construire les param√®tres pour la requ√™te
    const params = new URLSearchParams();
    if (!useAllCountries) {
        // Quand "Tous les pays" n'est pas coch√©, on passe toujours country_ids[],
        // m√™me si vide (ce qui signifie "aucun pays s√©lectionn√© = 0 questions")
        selectedCountries.forEach(id => params.append('country_ids[]', id));
        // Ajouter un param√®tre pour indiquer qu'on veut filtrer par pays
        params.append('filter_by_countries', '1');
    }
    selectedSpecificThemes.forEach(id => params.append('specific_theme_ids[]', id));
    selectedDifficulties.forEach(level => params.append('difficulty_levels[]', level));

    // Afficher un message de chargement
    tableBody.innerHTML = '<tr><td colspan="6" class="loading-message">Chargement des questions...</td></tr>';

    fetch(`/api/quiz-rule/get-questions?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.questions && data.questions.length > 0) {
                tableBody.innerHTML = '';
                data.questions.forEach(question => {
                    const row = document.createElement('tr');
                    row.classList.add('question-row');
                    row.dataset.questionId = question.id;
                    row.innerHTML = `
                        <td onclick="event.stopPropagation()"><input type="checkbox" name="selected_question_ids" value="${question.id}" checked onchange="updateSelectedQuestionsCount()"></td>
                        <td>${question.id}</td>
                        <td class="question-text">${escapeHtml(question.question_text)}</td>
                        <td>${escapeHtml(question.broad_theme_name || '-')}</td>
                        <td>${escapeHtml(question.specific_theme_name || '-')}</td>
                        <td class="difficulty-badge difficulty-${question.difficulty_level}">${question.difficulty_level}</td>
                    `;
                    
                    // Ajouter l'√©v√©nement de clic sur la ligne (sauf sur le checkbox)
                    row.addEventListener('click', function(e) {
                        if (e.target.type !== 'checkbox') {
                            showQuestionDetail(question.id);
                        }
                    });
                    
                    tableBody.appendChild(row);
                });
                
                // Cocher aussi le checkbox "Tout s√©lectionner"
                const selectAllCheckbox = document.getElementById('select-all-questions');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = true;
                }
                
                updateSelectedQuestionsCount();
            } else {
                tableBody.innerHTML = '<tr><td colspan="6" class="no-questions-message">Aucune question ne correspond aux crit√®res s√©lectionn√©s.</td></tr>';
                updateSelectedQuestionsCount();
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des questions:', error);
            tableBody.innerHTML = '<tr><td colspan="6" class="error-message">Erreur lors du chargement des questions.</td></tr>';
        });
}

// Fonction pour √©chapper le HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Mettre √† jour le compteur de questions s√©lectionn√©es et l'indicateur de mode
function updateSelectedQuestionsCount() {
    const allCheckboxes = document.querySelectorAll('input[name="selected_question_ids"]');
    const selectedCheckboxes = document.querySelectorAll('input[name="selected_question_ids"]:checked');
    const selectedCount = selectedCheckboxes.length;
    const totalCount = allCheckboxes.length;
    
    const countSpan = document.getElementById('selected-questions-count');
    if (countSpan) {
        countSpan.textContent = `${selectedCount} question(s) s√©lectionn√©e(s) sur ${totalCount}`;
    }
    
    // Mettre √† jour l'indicateur de mode
    const modeIndicator = document.getElementById('selection-mode-indicator');
    if (modeIndicator && totalCount > 0) {
        const isAutoMode = selectedCount === totalCount;
        
        if (isAutoMode) {
            modeIndicator.innerHTML = `
                <span class="mode-badge mode-auto">Mode: Automatique</span>
                <span class="mode-description">Toutes les questions correspondant aux crit√®res seront utilis√©es (y compris les nouvelles questions ajout√©es ult√©rieurement)</span>
            `;
        } else {
            modeIndicator.innerHTML = `
                <span class="mode-badge mode-manual">Mode: Manuel</span>
                <span class="mode-description">Seulement les ${selectedCount} question(s) s√©lectionn√©e(s) seront utilis√©es</span>
            `;
        }
    }
}

// G√©rer le checkbox "Tout s√©lectionner"
function initSelectAllQuestions() {
    const selectAllCheckbox = document.getElementById('select-all-questions');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const questionCheckboxes = document.querySelectorAll('input[name="selected_question_ids"]');
            questionCheckboxes.forEach(cb => {
                cb.checked = this.checked;
            });
            updateSelectedQuestionsCount();
        });
    }
}

// Afficher le d√©tail d'une question
function showQuestionDetail(questionId) {
    const modal = document.getElementById('question-detail-modal');
    const modalBody = document.getElementById('question-detail-body');
    
    if (!modal || !modalBody) return;
    
    // Afficher la modale avec un message de chargement
    modal.classList.remove('hidden');
    modalBody.innerHTML = '<div class="loading-message">Chargement du d√©tail de la question...</div>';
    
    // Charger les d√©tails de la question
    fetch(`/api/question/${questionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                modalBody.innerHTML = `<div class="error-message">${data.error}</div>`;
                return;
            }
            
            // Construire le HTML du d√©tail
            let html = `
                <div class="question-detail">
                    <div class="detail-section">
                        <h4>Question #${data.id}</h4>
                        <p class="question-full-text">${escapeHtml(data.question_text)}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>R√©ponses possibles</h4>
                        <ol class="answers-list">
            `;
            
            const answers = data.possible_answers || [];
            answers.forEach((answer, index) => {
                const isCorrect = data.correct_answer === String(index + 1);
                html += `<li class="${isCorrect ? 'correct-answer' : ''}">${escapeHtml(answer)} ${isCorrect ? '‚úì' : ''}</li>`;
            });
            
            html += `
                        </ol>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Th√®me large:</strong>
                            <span>${escapeHtml(data.broad_theme_name || '-')}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Sous-th√®me:</strong>
                            <span>${escapeHtml(data.specific_theme_name || '-')}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Difficult√©:</strong>
                            <span class="difficulty-badge difficulty-${data.difficulty_level}">${data.difficulty_level}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Auteur:</strong>
                            <span>${escapeHtml(data.author_name || '-')}</span>
                        </div>
                    </div>
            `;
            
            if (data.hint) {
                html += `
                    <div class="detail-section">
                        <h4>Indice</h4>
                        <p>${escapeHtml(data.hint)}</p>
                    </div>
                `;
            }
            
            if (data.detailed_answer) {
                html += `
                    <div class="detail-section">
                        <h4>R√©ponse d√©taill√©e</h4>
                        <p>${escapeHtml(data.detailed_answer)}</p>
                    </div>
                `;
            }
            
            if (data.source) {
                html += `
                    <div class="detail-section">
                        <h4>Source</h4>
                        <p class="source-text">${escapeHtml(data.source)}</p>
                    </div>
                `;
            }
            
            html += `
                    <div class="detail-stats">
                        <span>R√©pondue ${data.times_answered || 0} fois</span>
                        <span>Taux de r√©ussite: ${data.success_rate ? data.success_rate.toFixed(1) : 0}%</span>
                    </div>
                </div>
            `;
            
            modalBody.innerHTML = html;
        })
        .catch(error => {
            console.error('Erreur lors du chargement du d√©tail:', error);
            modalBody.innerHTML = '<div class="error-message">Erreur lors du chargement du d√©tail de la question.</div>';
        });
}

// Fermer la modale de d√©tail
function closeQuestionDetailModal() {
    const modal = document.getElementById('question-detail-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Initialiser les checkboxes de th√®mes apr√®s le chargement HTMX
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded d√©clench√©');
    // D√©lai pour s'assurer que HTMX a fini de charger le contenu
    setTimeout(function() {
        console.log('Timeout DOMContentLoaded termin√©, appel initThemeCheckboxes');
        initThemeCheckboxes();
        initSelectAllQuestions();
    }, 100);
});

// Aussi essayer avec un √©v√©nement HTMX si disponible
document.addEventListener('htmx:afterSwap', function(evt) {
    console.log('htmx:afterSwap d√©clench√©', evt.detail.target);
    if (evt.detail.target.id === 'rule-form-container' || evt.detail.target.closest('#rule-form-container')) {
        console.log('Cible correspond, appel initThemeCheckboxes');
        setTimeout(function() {
            console.log('Timeout htmx:afterSwap termin√©, appel initThemeCheckboxes');
            initThemeCheckboxes();
            initSelectAllQuestions();
        }, 50);
    }
});

// Charger les questions quand on acc√®de √† l'onglet "S√©lection de questions"
document.addEventListener('click', function(e) {
    const tab = e.target.closest('.tab[data-tab="questions"]');
    if (tab) {
        setTimeout(loadQuestionsForSelection, 100);
            // Recalculer le score quand on navigue ici (au cas o√π)
            setTimeout(computeMaxScore, 150);
    }
});

// Appel direct au cas o√π les √©v√©nements ne se d√©clenchent pas
console.log('Script charg√©, tentative d\'initialisation directe');
try {
    initThemeCheckboxes();
} catch (e) {
    console.error('Erreur lors de l\'initialisation directe:', e);
}
</script>
<style>
.form-wrapper{background:var(--card-bg);border:1px solid var(--border-color);border-radius:.75rem;box-shadow:var(--shadow);padding:1rem;max-width:1100px;width:100%}
.form-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.form-column{display:flex;flex-direction:column;gap:.75rem}
.fieldset{border:1px solid var(--border-color);border-radius:.5rem;padding:.75rem}
.checkboxes-inline{display:flex;gap:1rem;flex-wrap:wrap}
.grid-5{display:grid;grid-template-columns:repeat(5,minmax(90px,1fr));gap:.5rem}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem}
.themes-grid-select{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.5rem;max-height:200px;overflow:auto;border:1px dashed var(--border-color);border-radius:.5rem;padding:.5rem}
.chip{display:flex;align-items:center;gap:.35rem;padding:.35rem .5rem;border:1px solid var(--border-color);border-radius:999px;background:#fff;cursor:pointer}
.small{font-size:.8rem;color:var(--text-light)}

/* Onglets */
.tabs{display:flex;flex-direction:column;gap:.75rem}
.tabs-nav{display:flex;gap:.25rem;align-items:flex-end;border-bottom:1px solid var(--border-color)}
.tab{appearance:none;background:transparent;border:none;padding:.5rem .75rem;cursor:pointer;border-bottom:2px solid transparent;color:var(--text-light)}
.tab:hover{color:inherit}
.tab.active{color:inherit;border-bottom-color:var(--primary-color);font-weight:600}
.tabs-panels{padding-top:.25rem}
.tab-panel{display:none}
.tab-panel.active{display:block}
.tab-actions{display:flex;justify-content:flex-end;gap:.75rem;margin-top:1rem}
.field-error{color:#dc3545;font-size:.875rem;margin-top:.25rem}
.question-counter{margin-top:1rem;padding:1rem;border:1px solid var(--border-color);border-radius:.5rem;background:#f8f9fa}
.question-count-info{display:flex;align-items:center;gap:.5rem;font-size:.9rem;color:var(--text-color)}
.count-icon{font-size:1.2rem}

/* Tableau de s√©lection de questions */
.question-selection-info{margin-bottom:1rem;padding:.75rem;background:#e7f3ff;border-left:3px solid var(--primary-color);border-radius:.25rem}
.question-selection-info p{margin:0 0 .5rem 0;font-size:.9rem}
.question-selection-info p:last-child{margin-bottom:0}
.selection-mode-indicator{margin-bottom:1rem;padding:1rem;border-radius:.5rem;display:flex;align-items:center;gap:1rem;background:#f8f9fa;border:2px solid #dee2e6}
.mode-badge{padding:.5rem 1rem;border-radius:.25rem;font-weight:600;font-size:.9rem}
.mode-auto{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.mode-manual{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}
.mode-description{font-size:.875rem;color:var(--text-light);flex:1}
#questions-table-container{max-height:500px;overflow:auto;border:1px solid var(--border-color);border-radius:.5rem}
.questions-selection-table{width:100%;border-collapse:collapse;font-size:.9rem}
.questions-selection-table thead{position:sticky;top:0;background:var(--card-bg);z-index:10;box-shadow:0 2px 4px rgba(0,0,0,.1)}
.questions-selection-table th{padding:.75rem;text-align:left;border-bottom:2px solid var(--border-color);font-weight:600;background:#f8f9fa}
.questions-selection-table td{padding:.75rem;border-bottom:1px solid var(--border-color)}
.questions-selection-table tbody tr:hover{background:#f8f9fa}
.question-text{max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.difficulty-badge{display:inline-block;padding:.25rem .5rem;border-radius:.25rem;font-weight:600;text-align:center}
.difficulty-1{background:#d4edda;color:#155724}
.difficulty-2{background:#d1ecf1;color:#0c5460}
.difficulty-3{background:#fff3cd;color:#856404}
.difficulty-4{background:#f8d7da;color:#721c24}
.difficulty-5{background:#d6d8db;color:#1b1e21}
.loading-message,.no-questions-message,.error-message{text-align:center;padding:2rem;color:var(--text-light);font-style:italic}
.error-message{color:#dc3545}
.questions-selection-summary{margin-top:1rem;padding:.75rem;background:#f8f9fa;border-radius:.5rem;text-align:center;font-weight:600}
.question-row{cursor:pointer}
.question-row:hover{background:#e3f2fd !important}

/* Modale de d√©tail de question */
.question-modal{position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000;display:flex;align-items:center;justify-content:center}
.question-modal.hidden{display:none}
.question-modal-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);cursor:pointer}
.question-modal-content{position:relative;background:var(--card-bg);border-radius:.75rem;box-shadow:0 10px 40px rgba(0,0,0,0.3);max-width:800px;width:90%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.question-modal-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;border-bottom:1px solid var(--border-color);background:#f8f9fa}
.question-modal-header h3{margin:0;font-size:1.25rem}
.question-modal-body{padding:1.5rem;overflow-y:auto;flex:1}
.question-detail{display:flex;flex-direction:column;gap:1.5rem}
.detail-section h4{margin:0 0 .75rem 0;color:var(--primary-color);font-size:1rem;border-bottom:2px solid var(--primary-color);padding-bottom:.25rem}
.question-full-text{font-size:1.1rem;font-weight:500;line-height:1.6;margin:0}
.answers-list{margin:0;padding-left:1.5rem}
.answers-list li{padding:.5rem 0;line-height:1.5}
.correct-answer{color:#28a745;font-weight:600;background:#d4edda;padding:.5rem;border-radius:.25rem;margin:.25rem 0}
.detail-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
.detail-item{display:flex;flex-direction:column;gap:.25rem;padding:.75rem;background:#f8f9fa;border-radius:.5rem}
.detail-item strong{color:var(--text-light);font-size:.875rem}
.detail-item span{font-size:1rem}
.source-text{font-size:.9rem;color:var(--text-light);font-style:italic}
.detail-stats{display:flex;gap:2rem;justify-content:center;padding:1rem;background:#e3f2fd;border-radius:.5rem;font-size:.9rem;color:#0c5460}
.detail-stats span{font-weight:600}

/* Score maximum */
.score-summary{margin-top:1rem;padding:1rem;border:1px solid var(--border-color);border-radius:.5rem;background:#f8f9fa}
.score-line{font-size:1rem;margin-bottom:.25rem}
.score-breakdown{color:var(--text-light)}
</style>


