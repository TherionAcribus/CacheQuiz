<div class="form-wrapper">
    <div class="form-header">
        <h2>{% if rule %}Éditer le set de règles{% else %}Nouveau set de règles{% endif %}</h2>
        <button class="btn-close" type="button" onclick="document.getElementById('rule-form-container').classList.add('hidden')">✕</button>
    </div>

    <form {% if rule %}hx-post="/api/quiz-rule/{{ rule.id }}"{% else %}hx-post="/api/quiz-rule"{% endif %}
          hx-target="#quiz-rules-list" hx-swap="innerHTML"
          hx-on::after-request="document.getElementById('rule-form-container').classList.add('hidden')">

        <div class="tabs" hx-on:click="var btn=event.target.closest('.tab, .tab-next'); if(!btn) return; var wrap=event.currentTarget; var nav=wrap.querySelector('.tabs-nav'); var key=btn.classList.contains('tab')?btn.getAttribute('data-tab'):btn.getAttribute('data-next-tab'); if(key){nav.querySelectorAll('.tab').forEach(function(b){var on=b.getAttribute('data-tab')===key; b.classList.toggle('active',on); b.setAttribute('aria-selected',on?'true':'false')}); wrap.querySelectorAll('.tabs-panels .tab-panel').forEach(function(p){p.classList.toggle('active', p.getAttribute('data-tab')===key)});}">
            <div class="tabs-nav" role="tablist" aria-label="Règles - onglets">
                <button type="button" class="tab active" data-tab="general" aria-selected="true">Général</button>
                <button type="button" class="tab" data-tab="timing" aria-selected="false">Timer & Difficultés</button>
                <button type="button" class="tab" data-tab="themes" aria-selected="false">Thèmes</button>
                <button type="button" class="tab" data-tab="scoring" aria-selected="false">Scoring</button>
                <button type="button" class="tab" data-tab="messages" aria-selected="false">Messages</button>
            </div>
            <div class="tabs-panels">
                <div class="tab-panel active" data-tab="general">
                    <div class="form-column">
                        <div class="form-group">
                            <label for="name">Nom *</label>
                            <input id="name" name="name" type="text" required value="{{ rule.name if rule else '' }}"
                                   onblur="checkRuleName(this)">
                            <div id="name-error" class="field-error"></div>
                        </div>

                        <div class="form-group">
                            <label for="slug">Slug</label>
                            <input id="slug" name="slug" type="text" placeholder="mode-expert" value="{{ rule.slug if rule and rule.slug else '' }}"
                                   onblur="checkRuleSlug(this)"
                                   oninput="handleSlugInput(this)">
                            <div id="slug-error" class="field-error"></div>
                        </div>


                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="3">{{ rule.description if rule else '' }}</textarea>
                        </div>

                        <div class="form-group">
                            <label for="comment">Commentaire interne</label>
                            <textarea id="comment" name="comment" rows="2">{{ rule.comment if rule else '' }}</textarea>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label"><input type="checkbox" name="is_active" {% if rule and rule.is_active %}checked{% endif %}> Actif</label>
                        </div>
                    </div>

                    <div class="tab-actions">
                        <button type="button" class="btn btn-primary tab-next" data-next-tab="timing">Suivant →</button>
                    </div>
                </div>

                <div class="tab-panel" data-tab="timing">
                    <div class="form-column">
                        <fieldset class="fieldset">
                            <legend>Timer</legend>
                            <div class="form-group">
                                <label for="timer_seconds">Durée par question (secondes)</label>
                                <input id="timer_seconds" name="timer_seconds" type="number" min="5" step="1" value="{{ rule.timer_seconds if rule else 30 }}">
                            </div>
                        </fieldset>

                        <fieldset class="fieldset">
                            <legend>Difficultés utilisées</legend>
                            <div class="checkboxes-inline">
                                {% set selected = rule.get_allowed_difficulties() if rule else [] %}
                                {% for d in [1,2,3,4,5] %}
                                <label><input type="checkbox" name="allowed_difficulties" value="{{ d }}" {% if d in selected %}checked{% endif %}> {{ d }}</label>
                                {% endfor %}
                            </div>
                            <div class="form-group">
                                <label>Nombre de questions par difficulté</label>
                                <div class="grid-5">
                                    {% for d in [1,2,3,4,5] %}
                                    <div>
                                        <label for="qpd{{ d }}" class="small">Diff {{ d }}</label>
                                        {% set qmap = rule.get_questions_per_difficulty() if rule else {} %}
                                        <input id="qpd{{ d }}" name="questions_per_difficulty_{{ d }}" type="number" min="0" step="1" value="{{ qmap.get(d|string) if qmap.get(d|string) else '' }}">
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <div class="tab-actions">
                        <button type="button" class="btn btn-primary tab-next" data-next-tab="themes">Suivant →</button>
                    </div>
                </div>

                <div class="tab-panel" data-tab="themes">
                    <div class="form-column">
                        <fieldset class="fieldset">
                            <legend>Thèmes utilisés</legend>
                            <label class="checkbox-label"><input type="checkbox" id="use_all_broad_themes" name="use_all_broad_themes" {% if not rule or rule.use_all_broad_themes %}checked{% endif %}> Utiliser tous les thèmes larges</label>
                            <div class="themes-grid-select">
                                {% for theme in themes %}
                                <label class="chip"><input type="checkbox" name="allowed_broad_theme_ids" value="{{ theme.id }}" {% if rule and (not rule.use_all_broad_themes) and (theme in rule.allowed_broad_themes) %}checked{% endif %}> {% if theme.icon %}{{ theme.icon }} {% endif %}{{ theme.name }}</label>
                                {% endfor %}
                            </div>

                            <label class="checkbox-label"><input type="checkbox" id="use_all_specific_themes" name="use_all_specific_themes" {% if not rule or rule.use_all_specific_themes %}checked{% endif %}> Utiliser tous les sous-thèmes</label>
                            <div class="themes-grid-select">
                                {% for st in specific_themes %}
                                <label class="chip"><input type="checkbox" name="allowed_specific_theme_ids" value="{{ st.id }}" {% if rule and (not rule.use_all_specific_themes) and (st in rule.allowed_specific_themes) %}checked{% endif %}> {% if st.icon %}{{ st.icon }} {% endif %}{{ st.name }} ({{ st.broad_theme.name }})</label>
                                {% endfor %}
                            </div>
                        </fieldset>
                    </div>

                    <div class="tab-actions">
                        <button type="button" class="btn btn-primary tab-next" data-next-tab="scoring">Suivant →</button>
                    </div>
                </div>

                <div class="tab-panel" data-tab="scoring">
                    <div class="form-column">
                        <fieldset class="fieldset">
                            <legend>Scoring</legend>
                            <div class="form-group">
                                <label for="scoring_base_points">Points par question</label>
                                <input id="scoring_base_points" name="scoring_base_points" type="number" min="0" step="1" value="{{ rule.scoring_base_points if rule else 1 }}">
                            </div>
                            <div class="form-group">
                                <label for="scoring_difficulty_bonus_type">Bonus difficulté</label>
                                <select id="scoring_difficulty_bonus_type" name="scoring_difficulty_bonus_type">
                                    {% set s = rule.scoring_difficulty_bonus_type if rule else 'none' %}
                                    <option value="none" {% if s == 'none' %}selected{% endif %}>Aucun</option>
                                    <option value="add" {% if s == 'add' %}selected{% endif %}>Addition (+N)</option>
                                    <option value="mult" {% if s == 'mult' %}selected{% endif %}>Multiplicatif (×N)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Valeurs bonus par difficulté</label>
                                <div class="grid-5">
                                    {% set bmap = rule.get_difficulty_bonus_map() if rule else {} %}
                                    {% for d in [1,2,3,4,5] %}
                                    <div>
                                        <label for="bonus{{ d }}" class="small">Diff {{ d }}</label>
                                        <input id="bonus{{ d }}" name="difficulty_bonus_{{ d }}" type="number" step="0.1" value="{{ bmap.get(d|string) if bmap.get(d|string) else '' }}">
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" name="combo_bonus_enabled" {% if rule and rule.combo_bonus_enabled %}checked{% endif %}> Activer bonus de combo</label>
                                <div class="grid-2">
                                    <div>
                                        <label for="combo_step" class="small">Taille du palier</label>
                                        <input id="combo_step" name="combo_step" type="number" min="2" step="1" value="{{ rule.combo_step if rule and rule.combo_step else '' }}">
                                    </div>
                                    <div>
                                        <label for="combo_bonus_points" class="small">Points par palier</label>
                                        <input id="combo_bonus_points" name="combo_bonus_points" type="number" min="0" step="1" value="{{ rule.combo_bonus_points if rule and rule.combo_bonus_points else '' }}">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="perfect_quiz_bonus">Bonus perfect</label>
                                <input id="perfect_quiz_bonus" name="perfect_quiz_bonus" type="number" min="0" step="1" value="{{ rule.perfect_quiz_bonus if rule else 0 }}">
                            </div>
                        </fieldset>
                    </div>

                    <div class="tab-actions">
                        <button type="button" class="btn btn-primary tab-next" data-next-tab="messages">Suivant →</button>
                    </div>
                </div>

                <div class="tab-panel" data-tab="messages">
                    <div class="form-column">
                        <fieldset class="fieldset">
                            <legend>Messages</legend>
                            <div class="form-group">
                                <label for="intro_message">Message d'introduction</label>
                                <textarea id="intro_message" name="intro_message" rows="2">{{ rule.intro_message if rule else '' }}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="success_message">Message de réussite</label>
                                <textarea id="success_message" name="success_message" rows="2">{{ rule.success_message if rule else '' }}</textarea>
                            </div>
                        </fieldset>
                    </div>

                    <div class="tab-actions">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('rule-form-container').classList.add('hidden')">Annuler</button>
                        <button type="submit" class="btn btn-primary">{% if rule %}Mettre à jour{% else %}Créer{% endif %}</button>
                    </div>
                </div>
            </div>
        </div>

    </form>
</div>

<script>
let autoGeneratedSlug = '{{ rule.slug if rule and rule.slug else "" }}'; // Slug initial ou généré automatiquement

function slugify(text) {
    // Normalisation basique des accents
    const accentMap = {
        'à': 'a', 'â': 'a', 'ä': 'a', 'é': 'e', 'è': 'e', 'ê': 'e', 'ë': 'e',
        'ï': 'i', 'î': 'i', 'ô': 'o', 'ö': 'o', 'ù': 'u', 'û': 'u', 'ü': 'u',
        'ÿ': 'y', 'ñ': 'n', 'ç': 'c'
    };

    return text
        .toLowerCase()
        .trim()
        .replace(/[àâäéèêëïîôöùûüÿñç]/g, char => accentMap[char] || char)
        .replace(/[^a-z0-9\s\-_]/g, '') // Supprimer les caractères spéciaux restants
        .replace(/[\s\-_]+/g, '-') // Remplacer espaces/tirets/underscores multiples par un seul tiret
        .replace(/^-+|-+$/g, ''); // Supprimer les tirets au début et à la fin
}

function checkRuleName(input) {
    const name = input.value.trim();
    const excludeId = '{{ rule.id if rule else "" }}';
    const errorDiv = document.getElementById('name-error');

    if (!name) {
        errorDiv.innerHTML = '';
        return;
    }

    // Afficher un indicateur de chargement
    errorDiv.innerHTML = '<span style="color: #666;">Vérification...</span>';

    const params = new URLSearchParams({
        name: name,
        exclude_id: excludeId || ''
    });

    fetch(`/api/quiz-rule/check-name?${params}`)
        .then(response => response.text())
        .then(html => {
            errorDiv.innerHTML = html;
            // Si le nom est disponible, régénérer automatiquement le slug si nécessaire
            if (html.includes('est disponible')) {
                const slugInput = document.getElementById('slug');
                const newSlug = slugify(name);

                // Régénérer le slug seulement si l'utilisateur n'a pas fait de modification manuelle
                // ou si le slug actuel est vide
                if (!slugInput.value.trim() || slugInput.value === autoGeneratedSlug) {
                    autoGeneratedSlug = newSlug;
                    slugInput.value = newSlug;
                    // Vérifier automatiquement le slug généré
                    checkRuleSlug(slugInput);
                }
            }
        })
        .catch(error => {
            console.error('Erreur lors de la vérification:', error);
            errorDiv.innerHTML = '<span style="color: #dc3545;">Erreur de vérification</span>';
        });
}

function handleSlugInput(input) {
    // Si l'utilisateur modifie manuellement le slug, marquer qu'il n'est plus auto-généré
    const currentValue = input.value.trim();
    if (currentValue !== autoGeneratedSlug) {
        // L'utilisateur a fait une modification manuelle
        // On ne change pas autoGeneratedSlug ici, mais on indique que c'est modifié manuellement
    }
}

function checkRuleSlug(input) {
    const slug = input.value.trim();
    const excludeId = '{{ rule.id if rule else "" }}';
    const errorDiv = document.getElementById('slug-error');

    if (!slug) {
        errorDiv.innerHTML = '';
        return;
    }

    // Afficher un indicateur de chargement
    errorDiv.innerHTML = '<span style="color: #666;">Vérification...</span>';

    const params = new URLSearchParams({
        slug: slug,
        exclude_id: excludeId || ''
    });

    fetch(`/api/quiz-rule/check-slug?${params}`)
        .then(response => response.text())
        .then(html => {
            errorDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Erreur lors de la vérification:', error);
            errorDiv.innerHTML = '<span style="color: #dc3545;">Erreur de vérification</span>';
        });
}

// Gestion de la concordance des checkboxes de thèmes
function initThemeCheckboxes() {
    console.log('Initialisation des checkboxes de thèmes...');

    // Thèmes larges
    const useAllBroadThemes = document.getElementById('use_all_broad_themes');
    const broadThemeCheckboxes = document.querySelectorAll('input[name="allowed_broad_theme_ids"]');

    console.log('useAllBroadThemes:', useAllBroadThemes);
    console.log('broadThemeCheckboxes:', broadThemeCheckboxes.length, 'trouvés');

    // Sous-thèmes
    const useAllSpecificThemes = document.getElementById('use_all_specific_themes');
    const specificThemeCheckboxes = document.querySelectorAll('input[name="allowed_specific_theme_ids"]');

    console.log('useAllSpecificThemes:', useAllSpecificThemes);
    console.log('specificThemeCheckboxes:', specificThemeCheckboxes.length, 'trouvés');

    // Fonction pour vérifier si tous les thèmes larges sont cochés
    function checkAllBroadThemesChecked() {
        const checkedCount = Array.from(broadThemeCheckboxes).filter(cb => cb.checked).length;
        const totalCount = broadThemeCheckboxes.length;
        return checkedCount === totalCount && totalCount > 0;
    }

    // Fonction pour vérifier si tous les sous-thèmes sont cochés
    function checkAllSpecificThemesChecked() {
        const checkedCount = Array.from(specificThemeCheckboxes).filter(cb => cb.checked).length;
        const totalCount = specificThemeCheckboxes.length;
        return checkedCount === totalCount && totalCount > 0;
    }

    // Gestionnaire pour "Utiliser tous les thèmes larges"
    useAllBroadThemes?.addEventListener('change', function() {
        console.log('Changement de "Utiliser tous les thèmes larges":', this.checked);
        broadThemeCheckboxes.forEach(cb => {
            cb.checked = this.checked;
        });
    });

    // Gestionnaire pour "Utiliser tous les sous-thèmes"
    useAllSpecificThemes?.addEventListener('change', function() {
        specificThemeCheckboxes.forEach(cb => {
            cb.checked = this.checked;
        });
    });

    // Gestionnaire pour les thèmes larges individuels
    broadThemeCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            if (useAllBroadThemes) {
                useAllBroadThemes.checked = checkAllBroadThemesChecked();
            }
        });
    });

    // Gestionnaire pour les sous-thèmes individuels
    specificThemeCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            if (useAllSpecificThemes) {
                useAllSpecificThemes.checked = checkAllSpecificThemesChecked();
            }
        });
    });

    // Initialisation : vérifier l'état au chargement
    if (useAllBroadThemes) {
        useAllBroadThemes.checked = checkAllBroadThemesChecked();
    }
    if (useAllSpecificThemes) {
        useAllSpecificThemes.checked = checkAllSpecificThemesChecked();
    }
}

// Initialiser les checkboxes de thèmes après le chargement HTMX
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded déclenché');
    // Délai pour s'assurer que HTMX a fini de charger le contenu
    setTimeout(function() {
        console.log('Timeout DOMContentLoaded terminé, appel initThemeCheckboxes');
        initThemeCheckboxes();
    }, 100);
});

// Aussi essayer avec un événement HTMX si disponible
document.addEventListener('htmx:afterSwap', function(evt) {
    console.log('htmx:afterSwap déclenché', evt.detail.target);
    if (evt.detail.target.id === 'rule-form-container' || evt.detail.target.closest('#rule-form-container')) {
        console.log('Cible correspond, appel initThemeCheckboxes');
        setTimeout(function() {
            console.log('Timeout htmx:afterSwap terminé, appel initThemeCheckboxes');
            initThemeCheckboxes();
        }, 50);
    }
});

// Appel direct au cas où les événements ne se déclenchent pas
console.log('Script chargé, tentative d\'initialisation directe');
try {
    initThemeCheckboxes();
} catch (e) {
    console.error('Erreur lors de l\'initialisation directe:', e);
}
</script>
<style>
.form-wrapper{background:var(--card-bg);border:1px solid var(--border-color);border-radius:.75rem;box-shadow:var(--shadow);padding:1rem;max-width:1100px;width:100%}
.form-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.form-column{display:flex;flex-direction:column;gap:.75rem}
.fieldset{border:1px solid var(--border-color);border-radius:.5rem;padding:.75rem}
.checkboxes-inline{display:flex;gap:1rem;flex-wrap:wrap}
.grid-5{display:grid;grid-template-columns:repeat(5,minmax(90px,1fr));gap:.5rem}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem}
.themes-grid-select{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.5rem;max-height:200px;overflow:auto;border:1px dashed var(--border-color);border-radius:.5rem;padding:.5rem}
.chip{display:flex;align-items:center;gap:.35rem;padding:.35rem .5rem;border:1px solid var(--border-color);border-radius:999px;background:#fff;cursor:pointer}
.small{font-size:.8rem;color:var(--text-light)}

/* Onglets */
.tabs{display:flex;flex-direction:column;gap:.75rem}
.tabs-nav{display:flex;gap:.25rem;align-items:flex-end;border-bottom:1px solid var(--border-color)}
.tab{appearance:none;background:transparent;border:none;padding:.5rem .75rem;cursor:pointer;border-bottom:2px solid transparent;color:var(--text-light)}
.tab:hover{color:inherit}
.tab.active{color:inherit;border-bottom-color:var(--primary-color);font-weight:600}
.tabs-panels{padding-top:.25rem}
.tab-panel{display:none}
.tab-panel.active{display:block}
.tab-actions{display:flex;justify-content:flex-end;gap:.75rem;margin-top:1rem}
.field-error{color:#dc3545;font-size:.875rem;margin-top:.25rem}
</style>


