<div class="thread" id="thread">
  <div class="thread-header" style="padding:1rem;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center">
    <h3 style="margin:0">{{ conversation.subject or 'Conversation' }}</h3>
    <div style="display:flex;gap:0.5rem">
      <button class="btn btn-outline btn-sm" hx-post="/api/messages/mark-unread/{{ conversation.id }}" hx-target="#thread" hx-swap="none" hx-on::after-request="console.log('Marked as unread'); var convItem = document.querySelector('.conv-item.active'); if(convItem){ convItem.classList.remove('read'); convItem.classList.add('unread'); var title = convItem.querySelector('.conv-title span'); if(title && !title.classList.contains('unread-title')){ title.classList.add('unread-title'); } var text = convItem.querySelector('.conv-last'); if(text && !text.classList.contains('unread-text')){ text.classList.add('unread-text'); } var badge = document.createElement('span'); badge.className='badge unread-badge'; badge.textContent='1'; var titleSpan = convItem.querySelector('.conv-title'); if(titleSpan && !titleSpan.querySelector('.unread-badge')){ titleSpan.appendChild(badge); } }" title="Marquer comme non lu">
        Marquer non lu
      </button>
      <button class="btn btn-danger btn-sm" hx-post="/api/messages/delete/{{ conversation.id }}" hx-confirm="ÃŠtes-vous sÃ»r de vouloir supprimer cette conversation ? Elle sera supprimÃ©e de votre boÃ®te de rÃ©ception." hx-target="#messages-layout" hx-swap="outerHTML" title="Supprimer cette conversation">
        Supprimer
      </button>
    </div>
  </div>
  <div class="thread-messages" style="padding:1rem;flex:1;overflow-y:auto">
    {% for m in messages %}
    <div class="msg" style="margin-bottom:1rem">
      <div class="msg-meta" style="font-size:.85rem;color:var(--text-light)">
        <strong>{{ m.sender.username if m.sender else 'SystÃ¨me' }}</strong>
        <span>Â· {{ m.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
      </div>
      <div class="msg-body" style="white-space:pre-wrap">{{ m.content }}</div>
    </div>
    {% endfor %}
  </div>
  <div class="thread-form">
    <form hx-post="/api/messages/send" hx-target="#thread" hx-swap="innerHTML" class="message-compose-form">
      <input type="hidden" name="conversation_id" value="{{ conversation.id }}" />
      <div class="message-input-container">
        <textarea name="content" rows="4" class="message-textarea" placeholder="Tapez votre message ici..." required
                  hx-on:keydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); this.form.requestSubmit(); }"></textarea>
        <div class="message-actions">
          <div class="message-hint">
            <small>Appuyez sur EntrÃ©e pour envoyer, Maj+EntrÃ©e pour un retour Ã  la ligne</small>
          </div>
          <button type="submit" class="btn btn-primary btn-send">
            <span class="btn-text">Envoyer</span>
            <span class="btn-icon">ðŸ“¤</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<style>
.thread-form {
  border-top: 1px solid var(--border-color);
  background: var(--card-bg);
  padding: 0;
}

.message-compose-form {
  margin: 0;
  padding: 0;
}

.message-input-container {
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.message-textarea {
  width: 100%;
  min-height: 80px;
  max-height: 200px;
  padding: 0.75rem 1rem;
  border: 2px solid var(--border-color);
  border-radius: 0.75rem;
  background-color: var(--bg-color);
  color: var(--text-color);
  font-family: inherit;
  font-size: 0.95rem;
  line-height: 1.5;
  resize: vertical;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
  box-sizing: border-box;
}

.message-textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}

.message-textarea::placeholder {
  color: var(--text-light);
  opacity: 0.7;
}

.message-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

.message-hint {
  flex: 1;
  color: var(--text-light);
}

.message-hint small {
  font-size: 0.8rem;
  line-height: 1.2;
}

.btn-send {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.625rem 1.25rem;
  border: none;
  border-radius: 0.5rem;
  background-color: #02874d;
  color: white;
  font-weight: 500;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
  min-width: 100px;
  justify-content: center;
}

.btn-send:hover {
  background-color: #02693c;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.btn-send:active {
  background-color: #1e7e34;
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
}

.btn-icon {
  font-size: 1rem;
  line-height: 1;
}

.btn-text {
  font-weight: 500;
}

/* Responsive */
@media (max-width: 768px) {
  .message-actions {
    flex-direction: column;
    align-items: stretch;
    gap: 0.75rem;
  }

  .message-hint {
    text-align: center;
    order: 2;
  }

  .btn-send {
    order: 1;
    width: 100%;
  }

  .message-textarea {
    font-size: 16px; /* EmpÃªche le zoom sur mobile */
  }
}

/* Animation pour le focus */
.message-textarea:focus + .message-actions .message-hint {
  color: var(--primary-color);
}
</style>

