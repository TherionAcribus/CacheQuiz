<div class="thread" id="thread">
  <div class="thread-header" style="padding:1rem;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center">
    <h3 style="margin:0">{{ conversation.subject or 'Conversation' }}</h3>
    <button class="btn btn-outline btn-sm" hx-post="/api/messages/mark-unread/{{ conversation.id }}" hx-target="#thread" hx-swap="none" hx-on::after-request="console.log('Marked as unread'); var convItem = document.querySelector('.conv-item.active'); if(convItem){ convItem.classList.remove('read'); convItem.classList.add('unread'); var title = convItem.querySelector('.conv-title span'); if(title && !title.classList.contains('unread-title')){ title.classList.add('unread-title'); } var text = convItem.querySelector('.conv-last'); if(text && !text.classList.contains('unread-text')){ text.classList.add('unread-text'); } var badge = document.createElement('span'); badge.className='badge unread-badge'; badge.textContent='1'; var titleSpan = convItem.querySelector('.conv-title'); if(titleSpan && !titleSpan.querySelector('.unread-badge')){ titleSpan.appendChild(badge); } }" title="Marquer comme non lu">
      Marquer non lu
    </button>
  </div>
  <div class="thread-messages" style="padding:1rem;flex:1;overflow-y:auto">
    {% for m in messages %}
    <div class="msg" style="margin-bottom:1rem">
      <div class="msg-meta" style="font-size:.85rem;color:var(--text-light)">
        <strong>{{ m.sender.username if m.sender else 'Système' }}</strong>
        <span>· {{ m.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
      </div>
      <div class="msg-body" style="white-space:pre-wrap">{{ m.content }}</div>
    </div>
    {% endfor %}
  </div>
  <div class="thread-form" style="padding:1rem;border-top:1px solid var(--border-color)">
    <form hx-post="/api/messages/send" hx-target="#thread" hx-swap="innerHTML">
      <input type="hidden" name="conversation_id" value="{{ conversation.id }}" />
      <textarea name="content" rows="3" class="form-control" placeholder="Votre message..." required></textarea>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem">
        <button type="submit" class="btn btn-primary">Envoyer</button>
      </div>
    </form>
  </div>
</div>

