{% extends "base_public.html" %}

{% block content %}
<div class="page-header">
    {% if rule_set %}<h2>{{ rule_set.name }}</h2>{% endif %}
    {% if rule_set %}
    <div class="rule-set-info">
        <p><strong>Set de r√®gles actif:</strong> {{ rule_set.name }}</p>
        {% if rule_set.description %}
        <p>{{ rule_set.description }}</p>
        {% endif %}
        {% if rule_set.intro_message %}
        <div class="intro-message">{{ rule_set.intro_message }}</div>
        {% endif %}
        <div class="rule-summary">
            <span class="badge">‚è± {{ rule_set.timer_seconds }}s par question</span>
            <span class="badge">‚öôÔ∏è {{ rule_set.scoring_base_points }} pt/question</span>
            {% if rule_set.perfect_quiz_bonus %}
            <span class="badge">üèÜ Perfect: +{{ rule_set.perfect_quiz_bonus }}</span>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

{% if rule_set %}
<!-- Mode avec set de r√®gles pr√©d√©fini -->
<div id="quiz-setup" class="rule-set-mode">
    <div class="rule-details">
        <h3>R√®gles appliqu√©es</h3>
        <ul>
            <li><strong>Timer:</strong> {{ rule_set.timer_seconds }} secondes par question</li>
            {% set diffs = rule_set.get_allowed_difficulties() %}
            {% if diffs %}
            <li><strong>Difficult√©s:</strong> {{ diffs|join(', ') }}</li>
            {% else %}
            <li><strong>Difficult√©s:</strong> toutes</li>
            {% endif %}
            {% set qmap = rule_set.get_questions_per_difficulty() %}
            {% if qmap %}
            <li><strong>Nombre de questions par difficult√©:</strong> {{ qmap|tojson }}</li>
            {% endif %}
            {% if not rule_set.use_all_broad_themes %}
            <li><strong>Th√®mes larges:</strong>
                {% for theme in rule_set.allowed_broad_themes %}
                {{ theme.name }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </li>
            {% endif %}
            {% if not rule_set.use_all_specific_themes %}
            <li><strong>Sous-th√®mes:</strong>
                {% for st in rule_set.allowed_specific_themes %}
                {{ st.name }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </li>
            {% endif %}
            <li><strong>Scoring:</strong> {{ rule_set.scoring_base_points }} points par question
                {% if rule_set.scoring_difficulty_bonus_type == 'add' %}
                + bonus difficult√© {{ rule_set.get_difficulty_bonus_map()|tojson }}
                {% elif rule_set.scoring_difficulty_bonus_type == 'mult' %}
                √ó coefficient difficult√© {{ rule_set.get_difficulty_bonus_map()|tojson }}
                {% endif %}
                {% if rule_set.combo_bonus_enabled %}
                + combo (palier {{ rule_set.combo_step }}, +{{ rule_set.combo_bonus_points }})
                {% endif %}
                {% if rule_set.perfect_quiz_bonus %}
                +{{ rule_set.perfect_quiz_bonus }} si perfect
                {% endif %}
            </li>
        </ul>
    </div>

    <button class="btn btn-primary btn-large"
            hx-get="/api/quiz/next"
            hx-target="#quiz-stage"
            hx-swap="innerHTML"
            hx-vals='{"rule_set": "{{ rule_set.slug }}", "history": ""}'>
        üöÄ D√©marrer le quiz
    </button>

    <div class="rule-actions">
        <a href="/play" class="btn btn-secondary">Choisir un autre set</a>
        <a href="/quiz-rules" class="btn btn-outline">G√©rer les sets de r√®gles</a>
    </div>
</div>
{% else %}
<!-- S√©lection des sets de r√®gles -->
<div id="quiz-setup" class="rule-sets-selection">
    <h3>Choisissez votre mode de jeu</h3>
    <div class="rule-sets-grid">
        {% for rule_set_item in rule_sets %}
        <div class="rule-set-card">
            <div class="card-header">
                <h4>{{ rule_set_item.name }}</h4>
                {% if rule_set_item.description %}
                <p class="card-description">{{ rule_set_item.description }}</p>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="rule-summary">
                    <span class="badge">‚è± {{ rule_set_item.timer_seconds }}s</span>
                    <span class="badge">‚öôÔ∏è {{ rule_set_item.scoring_base_points }} pt</span>
                    {% if rule_set_item.perfect_quiz_bonus %}
                    <span class="badge">üèÜ +{{ rule_set_item.perfect_quiz_bonus }}</span>
                    {% endif %}
                </div>
                {% set diffs = rule_set_item.get_allowed_difficulties() %}
                {% if diffs %}
                <p class="difficulty-info">Difficult√©s: {{ diffs|join(', ') }}</p>
                {% else %}
                <p class="difficulty-info">Toutes difficult√©s</p>
                {% endif %}
                {% set qmap = rule_set_item.get_questions_per_difficulty() %}
                {% if qmap %}
                <p class="questions-info">Questions par difficult√©: {{ qmap|tojson }}</p>
                {% endif %}
            </div>
            <div class="card-actions">
                <a href="/play?rule_set={{ rule_set_item.slug }}" class="btn btn-primary">Jouer avec ce set</a>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not rule_sets %}
    <div class="no-rule-sets">
        <p>Aucun set de r√®gles n'est disponible pour le moment.</p>
        <a href="/quiz-rules" class="btn btn-primary">Cr√©er un set de r√®gles</a>
    </div>
    {% endif %}
</div>
{% endif %}

<div id="quiz-stage" class="quiz-stage">
    {% if rule_set %}
    <div class="placeholder">Cliquez sur "üöÄ D√©marrer le quiz" pour commencer avec le set de r√®gles "{{ rule_set.name }}".</div>
    <div class="placeholder small">Le scoring et les quotas seront appliqu√©s automatiquement.</div>
    {% else %}
    <div class="placeholder">S√©lectionnez vos filtres et cliquez sur "D√©marrer".</div>
    <div class="placeholder small">Les questions sont tir√©es au hasard parmi celles publi√©es.</div>
    <div class="placeholder small">L'historique √©vite les r√©p√©titions pendant la session.</div>
    {% endif %}
    <style>
        .placeholder { color: var(--muted-color); margin: .25rem 0; }
        .placeholder.small { font-size: .9rem; }
        .quiz-stage { margin-top: 1rem; }

        /* Styles pour la s√©lection des sets de r√®gles */
        .rule-sets-selection { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .rule-sets-selection h3 { text-align: center; margin-bottom: 2rem; color: var(--primary-color); }
        .rule-sets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }

        .rule-set-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: .75rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }
        .rule-set-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .card-header { margin-bottom: 1rem; }
        .card-header h4 { margin: 0 0 0.5rem 0; color: var(--primary-color); font-size: 1.25rem; }
        .card-description { margin: 0; color: var(--text-color); font-size: 0.9rem; line-height: 1.4; }

        .card-body { flex-grow: 1; margin-bottom: 1rem; }
        .rule-summary { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
        .rule-summary .badge {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .difficulty-info, .questions-info { margin: 0.5rem 0; font-size: 0.85rem; color: var(--muted-color); }

        .card-actions { text-align: center; }

        .no-rule-sets { text-align: center; padding: 2rem; color: var(--muted-color); }

        /* Styles pour le mode avec set de r√®gles s√©lectionn√© */
        .rule-set-info { background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: .5rem; padding: 1rem; margin-bottom: 1rem; }
        .rule-set-info h2 { margin: 0 0 .5rem 0; color: #0c4a6e; }
        .rule-set-info p { margin: .25rem 0; }
        .intro-message { background: #fefce8; border: 1px solid #eab308; border-radius: .25rem; padding: .5rem; margin-top: .5rem; font-style: italic; }
        .rule-set-mode { text-align: center; margin: 2rem 0; }
        .rule-details { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: .5rem; padding: 1.5rem; margin-bottom: 1.5rem; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto; }
        .rule-details h3 { margin: 0 0 1rem 0; color: var(--primary-color); }
        .rule-details ul { margin: 0; padding-left: 1.5rem; }
        .rule-details li { margin-bottom: .5rem; }
        .btn-large { font-size: 1.2rem; padding: .75rem 1.5rem; }
        .rule-actions { margin-top: 1rem; }
        .btn-outline { background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); }
        .btn-outline:hover { background: var(--primary-color); color: white; }

    </style>

    <script>
        // Fonction pour supprimer compl√®tement la configuration quand le quiz d√©marre
        function removeQuizSetup() {
            const setupElement = document.getElementById('quiz-setup');
            if (setupElement) {
                setupElement.remove();
            }
        }

        // √âcouter les √©v√©nements HTMX pour supprimer la configuration
        document.addEventListener('DOMContentLoaded', function() {
            // Quand HTMX charge du contenu dans #quiz-stage, supprimer la configuration
            document.getElementById('quiz-stage').addEventListener('htmx:afterSwap', function(evt) {
                // V√©rifier si le contenu charg√© contient une question (pas un placeholder)
                if (!evt.detail.xhr.responseText.includes('placeholder')) {
                    removeQuizSetup();
                }
            });
        });
    </script>
</div>
{% endblock %}


